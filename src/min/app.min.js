"use strict";var eduwebApp=angular.module("eduwebApp",["ui.router","ui.bootstrap","dialogs.main","daterangepicker","ui.select","angularFileUpload"]).constant("USER_ROLES",{all:"*",admin:"ADMIN",parent:"PARENT",staff:"STAFF",teacher:"TEACHER",sys_admin:"SYS_ADMIN"}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized",updatePwd:"update-pwd"}).config(["$httpProvider","$compileProvider",function(a,b){b.debugInfoEnabled(!1),a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]);eduwebApp.filter("numeric",["$filter",function(a){return function(b){return 0>b?(b=Math.abs(b),b=a("currency")(b,""),b="("+b+")"):b=a("currency")(b,"")}}]),eduwebApp.filter("titlecase",[function(){return function(a){return a=void 0===a||null===a?"":a,a.toString().toLowerCase().replace(/\b([a-z])/g,function(a){return a.toUpperCase()})}}]),eduwebApp.filter("arrayToList",[function(){return function(a){return a instanceof Array?a.join(", "):a}}]),eduwebApp.filter("makePositive",[function(){return function(a){return Math.abs(a)}}]),angular.module("eduwebApp").config(["$stateProvider","$urlRouterProvider","USER_ROLES",function(a,b,c){(function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),!a})(),function(){return window.innerWidth<=768}();b.otherwise("/"),a.state("index",{url:"/",templateUrl:"app/landing.html",data:{authorizedRoles:[c.admin,c.parent,c.staff,c.teacher,c.sys_admin]}}).state("login",{url:"/login",templateUrl:"app/login.html",data:{authorizedRoles:[c.admin,c.parent,c.staff,c.teacher,c.sys_admin]}}).state("dashboard",{url:"/dashboard",templateUrl:"app/dashboard.html",data:{authorizedRoles:[c.admin,c.parent,c.staff,c.teacher,c.sys_admin]}}).state("students",{url:"/students/:filter",templateUrl:"app/students/listStudents.html",data:{authorizedRoles:[c.admin,c.staff,c.teacher,c.sys_admin]}}).state("staff",{url:"/staff/:category/:dept",templateUrl:"app/staff/listStaff.html",data:{authorizedRoles:[c.admin,c.staff,c.teacher,c.sys_admin]}}).state("fees/dashboard",{url:"/fees/dashboard",templateUrl:"app/fees/feesDashboard.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("fees/opening_balances",{url:"/fees/opening_balances",templateUrl:"app/fees/openingBalances.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("fees/invoices",{url:"/fees/invoices/:balance_status",templateUrl:"app/fees/invoices.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("fees/payments_received",{url:"/fees/payments_received",templateUrl:"app/fees/paymentsReceived.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("fees/fee_structure",{url:"/fees/fee_structure",templateUrl:"app/fees/feeStructure.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("fees/receipt/print",{url:"/fees/receipt/print",templateUrl:"app/fees/receipt.html",controller:"printReceiptCtrl",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/departments",{url:"/school/departments",templateUrl:"app/school/departments.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/classes",{url:"/school/classes",templateUrl:"app/school/classes.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/subjects",{url:"/school/subjects",templateUrl:"app/school/subjects.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/grading",{url:"/school/grading",templateUrl:"app/school/grading.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/school_dates",{url:"/school/school_dates",templateUrl:"app/school/dates.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school/school_settings",{url:"/school/school_settings",templateUrl:"app/school/settings.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("exams/exams",{url:"/exams",templateUrl:"app/exams/listExams.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("exams/exam_types",{url:"/exams/exam_types",templateUrl:"app/exams/examTypes.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("exams/report_cards",{url:"/exams/report_cards",templateUrl:"app/exams/listReportCards.html",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("exams/report_card/print",{url:"/exams/report_card/print",templateUrl:"app/exams/reportCard.html",controller:"printReportCardCtrl",data:{authorizedRoles:[c.admin,c.sys_admin]}}).state("school_settings",{url:"/exams",templateUrl:"app/school/settings.html",data:{authorizedRoles:[c.admin,c.sys_admin]}})}]),angular.module("eduwebApp").factory("AuthInterceptor",["$rootScope","$q","Session","AUTH_EVENTS",function(a,b,c,d){return{responseError:function(c){return a.$broadcast({401:d.notAuthenticated,403:d.notAuthorized,419:d.sessionTimeout,440:d.sessionTimeout}[c.status],c),b.reject(c)}}}]),angular.module("eduwebApp").directive("adjustForSmallScreen",["$window","$rootScope","$timeout",function(a,b,c){return function(d,e,f){setTimeout(function(){function d(){b.isSmallScreen=window.innerWidth<768;$(".navbar-header").height(),$(".content-fixed-header").height();b.isSmallScreen}$(".fixedHeader-floating").remove(),$("#navigation").hasClass("in")&&$("#mainnav").trigger("click"),c(function(){d()},100),a.addEventListener("resize",function(){c(function(){d()},100)},!1)},100)}}]).directive("ignoreDirty",[function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){d.$setPristine=function(){},d.$pristine=!1}}}]).directive("numericOnly",[function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){var b=a?a.replace(/[^\d.-]/g,""):null;return b!=a&&(d.$setViewValue(b),d.$commitViewValue(),d.$render()),b})}}}]).directive("ngEnter",[function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}]).directive("mytabset",[function(){return{restrict:"E",replace:!0,transclude:!0,controller:function(a,b){a.templateUrl="";var c=a.tabs=[];a.selectTab=this.selectTab=function(d){angular.forEach(c,function(a){a.selected=!1}),d.selected=!0,a.searchTxt="Search"==d.title?a.savedSearchTxt:"",b.checkIfMobile?"Search"==d.title?setTimeout(function(){},1):"History"==d.title?setTimeout(function(){a.formatHistoryDataTables()},1):"GeoFence"==d.title&&setTimeout(function(){a.initGFTrucksDataGrids("assignOutTable")},1):"Search"==d.title?setTimeout(function(){a.zoomToSearchResults()},1):"History"==d.title?setTimeout(function(){a.zoomToHistoryPaths()},1):"GeoFence"==d.title?setTimeout(function(){a.initGFTrucksDataGrids("assignOutTable")},1):"Assets"==d.title||("Performance"==d.title?a.plotCharts():"Directions"==d.title&&setTimeout(a.initDirections,100)),angular.forEach(a.positions,function(a,b){a.isExpanded=!1}),angular.forEach(a.historyData,function(a,b){a.isExpanded=!0}),$(".vehicle-details").removeClass("in")},this.setTabTemplate=function(b){a.templateUrl=b},this.addTab=function(a){0==c.length?(a.show=!0,this.selectTab(a)):a.show="always"==a.showWhen,c.push(a)},a.activateTab=function(b){var c=a.tabs[b];c.show=!0,a.selectTab(c)},a.hideTab=function(b){var c=a.tabs[b];c.show=!1}},template:'<div class="full-height"><div class="panel-tabs"><ul class="nav nav-pills" ng-transclude></ul></div><div class="full-height2" id="mainView"><div class="full-height" ng-include="templateUrl"></div></div></div>'}}]).directive("mytab",[function(){return{restrict:"E",replace:!0,require:"^mytabset",scope:{title:"@",templateUrl:"@",showWhen:"@"},link:function(a,b,c,d){d.addTab(a),a.select=function(){d.selectTab(a)},a.$watch("selected",function(){a.selected&&d.setTabTemplate(a.templateUrl)})},template:'<li ng-class="{active: selected}" ng-show="show" id="{{ id }}"><a href="" ng-click="select()">{{ title }}</a></li>'}}]).directive("slideToggle",[function(){return{restrict:"A",link:function(a,b,c){var d=document.querySelector(c.slideToggle);c.expanded=c.expanded?c.expanded:!1,b.bind("click",function(){var a=d.querySelector(".slideable_content");if(c.expanded)d.style.height="0px";else{a.style.border="1px solid rgba(0,0,0,0)";a.clientHeight;a.style.border=0,d.style.height="340px"}})}}}]).directive("compile",["$compile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.compile)},function(d){c.html(d),a(c.contents())(b)})}}]).directive("focusMe",["$timeout",function(a){return{scope:{trigger:"@focusMe"},link:function(b,c){b.$watch("trigger",function(b){"true"===b&&a(function(){c[0].focus()})})}}}]),angular.module("eduwebApp").run(["$rootScope","$state","$window","$timeout","Session","Auth","AUTH_EVENTS","apiService","dialogs",function(a,b,c,d,e,f,g,h,i){a.loggedIn=!1,a.currentPage="",a.isSmallScreen=!1,a.activeSection="";a.$on("$stateChangeStart",function(b,d,h){var i=d.data.authorizedRoles.length>0?d.data.authorizedRoles:null,j=!1;a.currentPage=d.name,c.sessionStorage.userInfo?(j=!0,a.loggedIn=!0,a.currentUser=JSON.parse(c.sessionStorage.userInfo),e.create(a.currentUser),a.$broadcast(g.loginSuccess),a.getClassCats(),a.getAllClasses(),a.getEmpCats(),a.getDepts(),a.getCountries(),a.getInstallmentOptions()):"index"!=d.name&&(null===i||f.isAuthorized(i)||(f.isAuthenticated()?(a.$broadcast(g.notAuthorized),b.preventDefault()):j||(a.$broadcast(g.notAuthenticated),b.preventDefault())))}),a.$on("$stateChangeSuccess",function(b,c,e,f,g){a.navOpen=!1;var h=c.name;h=h.split("/"),a.activeSection=h[0],a.activeSubSection=void 0===h[1]?h[0]:h[1],a.activeSubSubSection=void 0===h[2]?h[0]:h[2],"print"==a.activeSubSubSection&&(a.isPrinting=!0),a.currentPageSection=h[0]+"/"+h[1],$("#navigation").hasClass("in")&&$("#mainnav").trigger("click"),d(function(){},1e3)}),a.wipNotice=function(){i.notify("Feature in Development","This feature is not yet complete, but hang in there, it will be awesome.",{size:"sm"})},a.checkIfMobile=function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a}(),a.showLogin=function(){a.$broadcast(g.notAuthenticated)},a.logout=function(){a.currentUser=null,a.permissions=null,f.logout()},a.formatStudentData=function(b){var c=b.map(function(b){b.student_name=b.first_name+" "+(b.middle_name||"")+" "+b.last_name;var c=a.allClasses.filter(function(a){return a.class_id==b.current_class})[0];return b.class_name=c?c.class_name:"",b.class_cat_id=c?c.class_cat_id:"",b.class_id=c?c.class_id:"",b.guardians&&(b.guardians=b.guardians.map(function(a){return a.parent_full_name=a.first_name+" "+(a.middle_name||"")+" "+a.last_name,a})),b.status=b.active?"Active":"In-Active",b.adoptedStr=b.adopted?"Yes":"No",b.adoptionAwareStr=b.adoption_aware?"Yes":"No",b.other_medical_conditions_str=b.other_medical_conditions?"Yes":"No",b.hospitalized_str=b.hospitalized?"Yes":"No",b.current_medical_treatment_str=b.current_medical_treatment?"Yes":"No",b});return c},a.$on("studentAdded",function(b,c){a.$broadcast("refreshStudents",c)}),a.$on("invoiceAdded",function(b,c){a.$broadcast("refreshInvoices",c)}),a.$on("paymentAdded",function(b,c){a.$broadcast("refreshPayments",c)}),a.$on("feeItemAdded",function(b,c){a.$broadcast("refreshItems",c)}),a.$on("deptAdded",function(b,c){a.$broadcast("refreshDepartments",c)}),a.$on("termAdded",function(b,c){a.$broadcast("refreshDates",c)}),a.$on("subjectAdded",function(b,c){a.$broadcast("refreshSubjects",c)}),a.$on("classAdded",function(b,c){a.$broadcast("refreshClasses",c)}),a.$on("examMarksAdded",function(b,c){a.$broadcast("refreshExamMarks",c)}),a.$on("gradingAdded",function(b,c){a.$broadcast("refreshGrades",c)}),a.$on("employeeAdded",function(b,c){a.$broadcast("refreshStaff",c)}),a.$on("reportCardAdded",function(b,c){a.$broadcast("refreshReportCards",c)}),a.$on("reportCardAdded",function(b,c){a.$broadcast("refreshReportCards",c)}),a.$on("setSettings",function(b,d){a.currentUser.settings=angular.copy(d);var e=JSON.parse(c.sessionStorage.userInfo);e.settings=d,c.sessionStorage.userInfo=JSON.stringify(e)}),a.getClassCats=function(){void 0===a.classCats&&h.getClassCats(void 0,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.classCats=c.data)},function(){})},a.getAllClasses=function(){void 0===a.allClasses&&h.getAllClasses({},function(b){var c=angular.fromJson(b);return"success"==c.response&&(a.allClasses=c.data),c.data},function(){})},a.getDepts=function(){void 0===a.allDepts&&h.getDepts({},function(b){var c=angular.fromJson(b);return"success"==c.response&&(a.allDepts=c.data),c.data},function(){})},a.getEmpCats=function(){void 0===a.empCats&&h.getEmpCats({},function(b){var c=angular.fromJson(b);return"success"==c.response&&(a.empCats=c.data),c.data},function(){})},a.getCountries=function(){void 0===a.countries&&h.getCountries({},function(b){var c=angular.fromJson(b);return"success"==c.response&&(a.countries=c.data),c.data},function(){})},a.getInstallmentOptions=function(){void 0===a.installmentOptions&&h.getInstallmentOptions({},function(b){var c=angular.fromJson(b);return"success"==c.response&&(a.installmentOptions=c.data),c.data},function(){})}}]),angular.module("eduwebApp").controller("ParentController",["$scope","$rootScope","$uibModal","dialogs","Auth","AUTH_EVENTS","USER_ROLES","$filter","$state","apiService",function(a,b,c,d,e,f,g,h,i,j){a.modalShown=!1,b.updatePwd=!1;var k=function(b){if(!a.modalShown){a.modalShown=!0;var d=c.open({templateUrl:"app/login.html",controller:"LoginCtrl",backdrop:"static",resolve:{token:function(){return b.token}}});d.result.then(function(){a.modalShown=!1},function(){a.modalShown=!1})["finally"](function(){a.modalInstance=void 0})}},l=function(){switch(b.permissions=[],b.currentUser.user_type){case"SYS_ADMIN":b.permissions={dashboard:{view:!0},students:{view:!0,add:!0,edit:!0,"import":!0},staff:{view:!0,add:!0,edit:!0,"import":!0},fees:{dashboard:{view:!0,add:!0,edit:!0},opening_balances:{view:!0,add:!0,edit:!0},invoices:{view:!0,add:!0,edit:!0,"delete":!0},payments_received:{view:!0,add:!0,edit:!0,"delete":!0},fee_structure:{view:!0,add:!0,edit:!0}},school:{school_settings:{view:!0,add:!0,edit:!0},school_dates:{view:!0,add:!0,edit:!0},grading:{view:!0,add:!0,edit:!0},subjects:{view:!0,add:!0,edit:!0},departments:{view:!0,add:!0,edit:!0},classes:{view:!0,add:!0,edit:!0}},exams:{exams:{view:!0,add:!0,edit:!0,"import":!0},exam_types:{view:!0,add:!0,edit:!0},report_cards:{view:!0,add:!0,edit:!0}},news:{view:!0,add:!0,edit:!0}};break;case"TEACHER":b.permissions={dashboard:{view:!0},students:{view:!0},school:{classes:{view:!0,add:!0,edit:!0}},exams:{exams:{view:!0,add:!0,edit:!0,"import":!0},exam_types:{view:!0,add:!0,edit:!0},report_cards:{view:!0,add:!0,edit:!0}},news:{view:!0,add:!0,edit:!0},class_blog:{view:!0,add:!0,edit:!0}};break;default:b.permissions={dashboard:{view:!0}}}a.navItems=[],a.subOptions=[];var c=0;angular.forEach(b.permissions,function(b,d){if(void 0===b.view){var e={};angular.forEach(b,function(a,b){0==c&&(e={id:d+"/"+b,label:h("titlecase")(d.split("_").join(" ")),section:d,subnav:[]}),e.subnav.push({id:d+"/"+b,label:h("titlecase")(b.split("_").join(" ")),section:d+"/"+b,subSection:b}),c++}),a.navItems.push(e)}else b.view&&a.navItems.push({id:d,label:h("titlecase")(d.split("_").join(" ")),section:d});c=0}),b.navItems=a.navItems;var d=b.currentPage;d=d.split("/");var e=d[0];d[1];angular.forEach(b.navItems,function(a,c){var d=a.section;d.toUpperCase()==e.toUpperCase()&&(b.mainSubNavItems=a.subnav)})},m=function(a){b.$broadcast("displayLoginError",a)},n=function(){b.$broadcast("displayLoginError"),b.updatePwd=!0;var a=d.create("updatePwd.html","updatePwdCtrl",{user:b.currentUser},{size:"md",backdrop:"static"});a.result.then(function(a){b.$broadcast("pwdUpdatedMsg")},function(){})},o=function(){b.loggedIn=!1,i.go("index")};a.userRoles=g,a.isAuthorized=e.isAuthorized,b.$on(f.notAuthorized,k),b.$on(f.notAuthenticated,k),b.$on(f.sessionTimeout,k),b.$on(f.logoutSuccess,o),b.$on(f.loginSuccess,l),b.$on(f.loginFailed,function(a,b){m(b)}),b.$on(f.updatePwd,n),a.openModal=function(c,e,f,g){if($("#filterLinks").hasClass("in")&&$("#subnav").trigger("click"),!a.modalShown){a.modalShown=!0;var h=e+"Ctrl";void 0===f&&(f="lg");var i=d.create("app/"+c+"/"+e+".html",h,g,{keyboard:!0,backdrop:"static",size:f});i.result.then(function(c){a.modalShown=!1,b.isSearchModal=!1,b.printModal=!1},function(){a.modalShown=!1,b.isSearchModal=!1,b.printModal=!1}),b.theModal=i}},b.chartColors=["rgba(151,187,205,1)","rgba(220,220,220,1)","rgba(247,70,74,1)","rgba(70,191,189,1)","rgba(253,180,92,1)","rgba(148,159,177,1)","rgba(77,83,96,1)","rgba(181,221,56,1)","rgba(218,150,240,1)"]}]),angular.module("eduwebApp").controller("landingCtrl",["$scope","$rootScope","$state","$window","Auth","apiService",function(a,b,c,d,e,f,g){a.credentials={},a.loginForm={},a.error=!1,a.loggingIn=!1;if(a.hitEnter=function(b){a.submit()},a.submit=function(){return a.submitted=!0,a.loggingIn=!0,a.loginForm.$invalid?(a.error=!0,a.errorMsg="You must enter your login credentials below.",void(a.loggingIn=!1)):void a.login(a.credentials)},a.cancel=function(){},a.login=function(d){a.error=!1,e.login(d,function(d){a.loggingIn=!1,a.loggedIn=!0,void 0===b.currentUser.settings["School Name"]?c.go("school/school_settings"):c.go("dashboard")},function(b){a.credentials.user_pwd="",a.error=!0,a.loggingIn=!1})},b.$on("displayLoginError",function(b,c){a.errorMsg=c.errorMsg,a.credentials.user_pwd="",a.error=!0,a.loggingIn=!1}),b.$on("pwdUpdatedMsg",function(b,c){a.credentials.user_pwd="",a.submitted=!1,a.error=!1,a.pwdupdated=!0,a.loggingIn=!1,a.loginForm.user_pwd.$dirty=!1,a.loginForm.user_pwd.$invalid=!1,$("input[name=user_pwd]").focus()}),d.sessionStorage.userInfo){var h=JSON.parse(d.sessionStorage.userInfo);a.login(h)}}]),angular.module("eduwebApp").controller("dashboardCtrl",["$scope","$rootScope","apiService",function(a,b,c){a.studentsLoading=!0,a.staffLoading=!0,a.examsLoading=!0,a.fees1Loading=!0,a.fees2Loading=!0,a.fees3Loading=!0,a.newsLoading=!0;var d=function(){c.getClassCatsSummary(status,function(b){var c=angular.fromJson(b);"success"==c.response?(a.classCats=c.data,a.studentsLoading=!1):(a.error=!0,a.errMsg=c.data,a.studentsLoading=!1)},function(){})},e=function(){c.getDeptSummary(status,function(b){var c=angular.fromJson(b);"success"==c.response?(a.deptCats=c.data,a.staffLoading=!1):(a.error=!0,a.errMsg=c.data,a.staffLoading=!1)},function(){})},f=function(){c.getCurrentTerm({},function(b){var c=angular.fromJson(b);if("success"==c.response)if(a.currentTerm=c.data||void 0,void 0!==a.currentTerm){a.currentTermTitle=a.currentTerm.term_name+" "+a.currentTerm.year;var d=moment().add(1,"day").format("YYYY-MM-DD");a.date={startDate:a.currentTerm.start_date,endDate:d},g(a.currentTerm.start_date,d)}else a.fees1Loading=!1,a.numPaymentsReceived=0},function(){});var b=moment().startOf("month").format("YYYY-MM-DD"),d=moment().endOf("month").format("YYYY-MM-DD");i(b,d),k()},g=function(a,b){var d=a+"/"+b+"/false";c.getPaymentsReceived(d,h,o)},h=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.numPaymentsReceived=void 0!==d.nodata?0:d.data.length,a.fees1Loading=!1):(a.prError=!0,a.prErrMsg=d.data,a.fees1Loading=!1)},i=function(a,b){var d=a+"/"+b;c.getPaymentsDue(d,j,o)},j=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.numPaymentsDue=void 0!==d.nodata?0:d.data.length,a.fees2Loading=!1):(a.prError=!0,a.prErrMsg=d.data,a.fees2Loading=!1)},k=function(){c.getPaymentsPastDue({},l,o)},l=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.numPaymentsPastDue=void 0!==d.nodata?0:d.data.length,a.fees3Loading=!1):(a.prError=!0,a.prErrMsg=d.data,a.fees3Loading=!1)},m=function(){c.getTopStudents(void 0,n,o)},n=function(b,c){var d=angular.fromJson(b);if("success"==d.response){a.examsLoading=!1;var e=void 0!==d.nodata?[]:d.data;a.classes=[];var f="",g=[],h=0;angular.forEach(e,function(b,c){b.class_id!=f&&(h>0&&(a.classes[h-1].students=g),a.classes.push({class_id:b.class_id,class_name:b.class_name,students:[]}),g=[],h++),g.push({student_name:b.student_name,student_id:b.student_id,total_mark:b.total_mark,total_grade_weight:b.total_grade_weight,position:b.rank,position_out_of:b.position_out_of,grade:b.grade}),f=b.class_id}),a.classes[h-1]&&(a.classes[h-1].students=g)}else a.prError=!0,a.prErrMsg=d.data,a.examsLoading=!1},o=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data},p=function(){d(),e(),f(),m()};setTimeout(p(),10),a.$on("$destroy",function(){a.journeysGrid&&a.journeysGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("LoginCtrl",["$scope","$rootScope","$state","$uibModalInstance","$window","Auth","apiService",function(a,b,c,d,e,f,g,h){a.credentials={},a.loginForm={},a.error=!1,a.loggingIn=!1;if(a.hitEnter=function(b){a.submit()},a.submit=function(){return a.submitted=!0,a.loggingIn=!0,a.loginForm.$invalid?(a.error=!0,a.errorMsg="You must enter your login credentials below.",void(a.loggingIn=!1)):void a.login(a.credentials)},a.cancel=function(){d.dismiss("canceled")},a.login=function(b){a.error=!1,f.login(b,function(b){a.loggingIn=!1,setTimeout(function(){d.dismiss("cancel")},100),c.go("dashboard")},function(b){a.credentials.user_pwd="",a.error=!0,a.loggingIn=!1})},b.$on("displayLoginError",function(b,c){a.errorMsg=c.errorMsg,a.credentials.user_pwd="",a.error=!0,a.loggingIn=!1}),b.$on("pwdUpdatedMsg",function(b,c){a.credentials.user_pwd="",a.submitted=!1,a.error=!1,a.pwdupdated=!0,a.loggingIn=!1,a.loginForm.user_pwd.$dirty=!1,a.loginForm.user_pwd.$invalid=!1,$("input[name=user_pwd]").focus()}),e.sessionStorage.userInfo){var i=JSON.parse(e.sessionStorage.userInfo);a.login(i)}}]).controller("updatePwdCtrl",["$scope","$uibModalInstance","data","$timeout","apiService",function(a,b,c,d,e){a.user=c.user,a.user.old_pwd=a.user.user_pwd,a.user.user_pwd="",a.cancel=function(){b.dismiss("Canceled")},a.updatePwd=function(c){if(a.user.old_pwd==a.user.user_pwd)c.user_pwd.$error.pwdnotnew=!0;else{var d={api_action:"update_pwd",user_name:a.user.user_name,new_user_pwd:a.user.user_pwd,user_id:a.user.user_id};e.postUserRequest(angular.toJson(d),function(c,d){b.close(a.user)},function(b,c){var d=angular.fromJson(b);a.error=!0,a.notificationMsg=d.data})}},a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.updatePwd()}}]).run(["$templateCache",function(a){a.put("updatePwd.html",'<div class="modal-header modal-warning dialog-header-form"><h4 class="modal-title"><span class="fa fa-exclamation-triangle"></span> Password is Expired</h4></div><div class="modal-body"><ng-form name="updatePwdDialog" novalidate role="form" class="form-horizontal" method="post"><div class="notification alert alert-danger" ng-show="error">{{notificationMsg}}</div><p>Your password has expired, please create a new password below.</p><div><label for="user_pwd">Password</label><div ng-class="{ \'has-error\' : updatePwdDialog.user_pwd.$dirty && updatePwdDialog.user_pwd.$error.pwdnotnew && (updatePwdDialog.user_pwd.$touched || updatePwdDialog.$submitted) }"><input type="password" class="form-control immediate-help" name="user_pwd" ng-model="user.user_pwd" password-validate="{{user.old_pwd}}" required id="inputPassword"><div class="input-help"><h4>Password must meet the following requirements:</h4><ul><li ng-class="pwdHasLetter">At least <strong>one letter</strong></li><li ng-class="pwdHasNumber">At least <strong>one number</strong></li> <li ng-class="pwdValidLength">At least <strong>8 characters long</strong></li></ul></div><p ng-show="updatePwdDialog.user_pwd.$dirty && updatePwdDialog.user_pwd.$error.pwdnotnew && (updatePwdDialog.user_pwd.$touched || updatePwdDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> You must enter a new password.</p></div></div><div ng-class="{ \'has-error\' : updatePwdDialog.verify_password.$dirty && updatePwdDialog.verify_password.$error.pwmatch && (updatePwdDialog.verify_password.$touched || updatePwdDialog.$submitted) }"><label for="verify_password">Verify Password</label><div><input type="password" class="form-control" name="verify_password" ng-model="user.verify_password" pw-check="inputPassword" required><p ng-show="updatePwdDialog.verify_password.$dirty && updatePwdDialog.verify_password.$error.pwmatch && (updatePwdDialog.verify_password.$touched || updatePwdDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Password does not match.</span></div></div></ng-form></div><div class="modal-footer"><div class="pull-left alert alert-danger col-sm-8" ng-show="error">{{msg}}</div><button type="button" class="btn btn-default" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="updatePwd(updatePwdDialog)">Update</button></div>')}]),angular.module("eduwebApp").controller("addExamMarksCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$timeout","$window",function(a,b,c,d,e,f,g,h){var i=function(){a.classes=f.classes,a.terms=f.terms,a.examTypes=f.examTypes,a.filters=f.filters,j(a.filters.class_id),a.getStudentExams()};setTimeout(i,1),a.$watch("filters.class",function(b,c){b!=c&&(a.filters.class_id=b.class_id,j(a.filters.class_id),d.getExamTypes(b.class_cat_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data)},m))});var j=function(b){d.getClassExams(b,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.classSubjectExams=c.data)},m)};a.cancel=function(){c.dismiss("canceled")},a.getStudentExams=function(b){if(b.$submitted=!0,!b.$invalid){a.examMarks={},a.marksNotFound=!1,void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0);var c=a.filters.class_id+"/"+a.filters.exam_type_id;d.getClassExams(c,function(b){a.loading=!1;var c=angular.fromJson(b);if("success"==c.response)if(void 0!==c.nodata)a.marksNotFound=!0,a.errMsg="The selected exam is not set up for this class.";else{a.subjects=c.data;var e=a.filters.class_id+"/"+a.filters.term_id+"/"+a.filters.exam_type_id;d.getClassExamMarks(e,k,m)}},m)}};var k=function(b,c){a.loading=!1;var d=angular.fromJson(b);if("success"==d.response)if(d.nodata)a.marksNotFound=!0,a.errMsg="There are no students in the selected classes.";else{a.students=d.data,a.currentFilters=angular.copy(a.filters),a.examMarks=[];var e="",f={},g=0;angular.forEach(a.students,function(b,c){b.student_id!=e&&(g>0&&(a.examMarks[g-1].marks=f),a.examMarks.push({student_name:b.student_name,student_id:b.student_id,marks:{}}),f={},g++);var d=a.subjects.filter(function(a){return a.subject_name==b.subject_name?a:void 0})[0];f[d.subject_name]={mark:b.mark,class_sub_exam_id:b.class_sub_exam_id,grade_weight:b.grade_weight},e=b.student_id}),a.examMarks[g-1].marks=f}else a.marksNotFound=!0,a.errMsg=d.data};a.save=function(c){if(!c.$invalid){var e=[];angular.forEach(a.examMarks,function(b,c){angular.forEach(b.marks,function(c,d){e.push({student_id:b.student_id,class_sub_exam_id:c.class_sub_exam_id,term_id:a.currentFilters.term_id,mark:c.mark})})});var f={user_id:b.currentUser.user_id,exam_marks:e};d.addExamMarks(f,l,m)}};var l=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Exam mark was updated.":"Exam marks were added.";b.$emit("examMarksAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},m=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("examTypesCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter","dialogs",function(a,b,c,d,e,f,g){a.alert={};var h=function(){i()};d(h,1);var i=function(){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),c.getExamTypes(void 0,function(b,c,e){var f=angular.fromJson(b);"success"==f.response?(a.examTypes=f.nodata?[]:f.data,d(j,10)):(a.error=!0,a.errMsg=f.data)},k)},j=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0},{targets:1,orderable:!1}],paging:!1,destroy:!0,filter:!0,order:[2,"asc"],info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",
lengthMenu:"Display _MENU_",emptyTable:"No grading entries found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",0)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},k=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addExamType=function(){var a=g.create("addExamType.html","addExamTypeCtrl",{},{size:"sm",backdrop:"static"});a.result.then(function(a){i()},function(){})},a.deleteExamType=function(b){var d=g.confirm("Delete Exam Type","You are deleting exam type <strong>"+b.exam_type+"</strong>, this <strong>can not be undone</strong>, do you wish to continue?",{size:"sm"});d.result.then(function(d){c.deleteExamType(b.exam_type_id,function(b,c){var d=angular.fromJson(b);"success"==d.response?i():(a.error=!0,a.errMsg=d.data)},k)})},a.$on("refreshExamTypes",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,i()},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("listExamsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$q","$parse",function(a,b,c,d,e,f,g){var h=!0;a.filters={},a.filters.status="true",a.students=[],a.filterShowing=!1,a.toolsShowing=!1;b.modalLoading=!1,a.alert={},a.refreshing=!1,a.getReport="examsTable";var i=function(){var d=[],e=f.defer();d.push(e.promise),void 0===b.allClasses?"TEACHER"==b.currentUser.user_type?c.getTeacherClasses(b.currentUser.emp_id,function(c){var d=angular.fromJson(c);"success"==d.response?(b.allClasses=d.data,a.classes=b.allClasses||[],a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0]?a.classes[0].class_id:null,e.resolve()):e.reject()},function(){e.reject()}):c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response?(b.allClasses=d.data,a.classes=b.allClasses||[],a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0]?a.classes[0].class_id:null,e.resolve()):e.reject()},function(){e.reject()}):(a.classes=b.allClasses,a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0].class_id,e.resolve());var g=f.defer();if(d.push(g.promise),void 0===b.terms)c.getTerms(void 0,function(c,d){var e=angular.fromJson(c);if("success"==e.response){a.terms=e.data,b.terms=e.data;var f=a.terms.filter(function(a){return a.current_term?a:void 0})[0];a.filters.term_id=f.term_id,g.resolve()}else g.reject()},function(){g.reject()});else{a.terms=b.terms;var h=a.terms.filter(function(a){return a.current_term?a:void 0})[0];a.filters.term_id=h.term_id,g.resolve()}var i=f.defer();d.push(i.promise),void 0===b.examTypes?c.getExamTypes(void 0,function(c){var d=angular.fromJson(c);"success"==d.response?(a.examTypes=d.data,b.examTypes=d.data,a.filters.exam_type_id=a.examTypes[0].exam_type_id,i.resolve()):i.reject()},function(){i.reject()}):(a.examTypes=b.examTypes,a.filters.exam_type_id=a.examTypes[0].exam_type_id,i.resolve()),f.all(d).then(function(){null!==a.filters.class_id&&a.getStudentExams()})};d(i,1),a.$watch("filters.class",function(b,e){b!=e&&(a.filters.class_id=b.class_id,c.getExamTypes(b.class_cat_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data,d(l,10))},n))}),a.getStudentExams=function(){a.examMarks={},a.tableHeader=[],a.marksNotFound=!1,a.getReport="";var b=a.filters.class_id+"/"+a.filters.term_id;null!==a.filters.exam_type_id&&(b+="/"+a.filters.exam_type_id),c.getAllStudentExamMarks(b,j,n)};var j=function(b,c){a.loading=!1;var e=angular.fromJson(b);if("success"==e.response)if(e.nodata)a.marksNotFound=!0,a.errMsg="There are currently no exam marks entered for this search criteria.";else{void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),a.examMarks=e.data,a.tableHeader=[];var f=["student_id","student_name","rank","exam_type"];angular.forEach(a.examMarks[0],function(b,c){if(-1===f.indexOf(c)){var d=c.replace(/, /g," / ").replace(/["']/g,"");a.tableHeader.push({title:d,key:c})}}),angular.forEach(a.examMarks,function(a){var b=0;angular.forEach(a,function(a,c){-1===f.indexOf(c)&&(b+=a)}),a.total=b}),a.getReport="examsTable",d(k,100)}else a.marksNotFound=!0,a.errMsg=e.data};a.displayMark=function(b,c){return g("examMarks["+b+']["'+c+'"]')(a)||"-"};var k=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[2,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No students found."}});var d=$(".navbar-fixed-top").height(),e=$("#body-content .content-fixed-header").height(),f=b.isSmallScreen?22:13;new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+e+f}),l(),h&&m()},l=function(){if(!b.isSmallScreen){var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a+45)}},m=function(){h=!1,e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.addExamMarks=function(){var b={classes:a.classes,terms:a.terms,examTypes:a.examTypes,filters:a.filters};a.openModal("exams","addExamMarks","lg",b)},a.importExamMarks=function(){b.wipNotice()},a.exportData=function(){b.wipNotice()},a.$on("refreshExamMarks",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,a.refreshing=!0,b.loading=!0,a.getStudentExams()};var n=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.$on("$destroy",function(){a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy()),b.isModal=!1})}]),angular.module("eduwebApp").controller("listReportCardsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$q","$parse",function(a,b,c,d,e,f,g){var h=!0;a.filters={},a.filters.status="true",a.students=[],a.filterShowing=!1,a.toolsShowing=!1;b.modalLoading=!1,a.alert={},a.refreshing=!1,a.getReport="reportTable";var i=function(){var d=moment().format("YYYY");c.getTerms(d,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.terms=c.data)},n),void 0===b.allClasses?"TEACHER"==b.currentUser.user_type?c.getTeacherClasses(b.currentUser.emp_id,function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses||[],a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0]?a.classes[0].class_id:null,a.getStudentReportCards())},n):c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses||[],a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0]?a.classes[0].class_id:null,a.getStudentReportCards())},n):(a.classes=b.allClasses,a.filters["class"]=a.classes[0],a.filters.class_id=a.classes[0].class_id,a.getStudentReportCards())};d(i,1),a.getStudentReportCards=function(){a.reportCards={},a.tableHeader=[],a.reportsNotFound=!1,a.getReport="";var b=a.filters["class"].class_id;c.getAllStudentReportCards(b,j,n)};var j=function(b,c){a.loading=!1;var e=angular.fromJson(b);if("success"==e.response)if(e.nodata)a.reportsNotFound=!0,a.errMsg="There are currently no report cards entered for this class.";else{a.rawReportCards=e.data,a.reportCards={},a.reportCards.students=[];var f="",g={},h=0;angular.forEach(a.rawReportCards,function(b,c){b.student_id!=f&&(h>0&&(a.reportCards.students[h-1].reports=g),a.reportCards.students.push({student_name:b.student_name,student_id:b.student_id,class_id:b.class_id,class_name:b.class_name,term_id:b.term_id,year:b.year,admission_number:b.admission_number}),g={},h++),g[b.term_name]=b.report_data,f=b.student_id}),a.reportCards.students[h-1].reports=g,a.getReport="reportTable",d(k,100)}else a.reportsNotFound=!0,a.errMsg=e.data};a.getReportCard=function(b,c,d){var e={student_id:b.student_id,student_name:b.student_name,admission_number:b.admission_number},f={student:e,class_name:b.class_name,class_id:b.class_id,term_id:b.term_id,term_name:c,year:b.year,reportData:d,adding:!1};a.openModal("exams","reportCard","lg",f)};var k=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[1,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No report cards found."}});var d=$(".navbar-fixed-top").height(),e=$("#body-content .content-fixed-header").height(),f=b.isSmallScreen?22:13;new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+e+f}),l(),h&&m()},l=function(){if(!b.isSmallScreen){var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a+45)}},m=function(){h=!1,e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.addReportCard=function(){var c={classes:b.allClasses,terms:a.terms,filters:a.filters,adding:!0};a.openModal("exams","reportCard","lg",c)},a.$on("refreshReportCards",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,a.refreshing=!0,b.loading=!0,a.getStudentReportCards()};var n=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.$on("$destroy",function(){a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy()),b.isModal=!1})}]),angular.module("eduwebApp").controller("printReportCardCtrl",["$scope","$rootScope",function(a,b){var c=function(){var c=window.printCriteria;b.isPrinting=!0,a.showReportCard=!0,a.student=angular.fromJson(c.student),a.report=angular.fromJson(c.report),a.overall=angular.fromJson(c.overall),a.overallLastTerm=angular.fromJson(c.overallLastTerm),a.examTypes=angular.fromJson(c.examTypes),a.reportData=angular.fromJson(c.reportData),a.totals=angular.fromJson(c.totals),a.comments=angular.fromJson(c.comments),a.nextTermStartDate=c.nextTermStartDate,a.total_overall_mark=c.total_overall_mark,a.loading=!1,setTimeout(function(){window.print(),setTimeout(function(){b.isPrinting=!1},100)},100)};setTimeout(c,1),a.$on("$destroy",function(){b.isPrinting=!1})}]),angular.module("eduwebApp").controller("reportCardCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$timeout","$window","$parse",function(a,b,c,d,e,f,g,h,i){b.isPrinting=!1,a.student=f.student||void 0,a.showSelect=void 0===a.student,a.classes=f.classes||[],a.terms=f.terms||[],a.filters=f.filters||[],a.adding=f.adding,a.thestudent={},a.examTypes={},a.canPrint=!1,a.report={},a.showReportCard=!1;var j=function(){void 0!==f.reportData?(a.reportData=angular.fromJson(f.reportData),a.originalData=angular.copy(a.reportData),a.report.class_name=f.class_name,a.report.term=f.term_name,a.report.year=f.year,a.currentFilters={},a.currentFilters.term={},a.currentFilters["class"]={},a.currentFilters.term.term_id=f.term_id,a.currentFilters["class"].class_id=f.class_id,a.setReportCardData()):d.getNextTerm({},function(b,c){var d=angular.fromJson(b);"success"==d.response&&(a.nextTermStartDate=d.data.start_date)},o);var c=f.class_id||a.filters["class"].class_id;if(d.getClassExams(c,function(b){var c=angular.fromJson(b);if("success"==c.response){var d=c.data;a.examTypes=d.reduce(function(a,b){return-1===a.indexOf(b.exam_type)&&a.push(b.exam_type),a},[])}},function(){}),void 0===a.student)if("TEACHER"==b.currentUser.user_type){var c=b.currentUser.emp_id+"/"+!0;d.getTeacherStudents(c,k,o)}else d.getAllStudents(!0,k,o)};g(j,1);var k=function(c){var d=angular.fromJson(c);"success"==d.response?a.students=d.nodata?{}:b.formatStudentData(d.data):(a.error=!0,a.errMsg=d.data)};a.$watch("filters.term",function(b,c){b!=c&&(a.filters.term_id=b.term_id)}),a.$watch("thestudent.selected",function(b,c){b!=c&&(a.student=a.thestudent.selected)}),a.clearSelect=function(b,c){c.stopPropagation();var b=i(b+".selected");b.assign(a,void 0)},a.getProgressReport=function(){a.currentFilters=angular.copy(a.filters),a.report.class_name=a.currentFilters.class_name,a.report.term=a.currentFilters.term.term_name,a.report.year=a.currentFilters.term.year;var b=a.student.student_id+"/"+a.filters["class"].class_id+"/"+a.filters.term_id;d.getStudentReportCard(b,l,o)};var l=function(b,c){var e=angular.fromJson(b);if("success"==e.response)if(void 0===e.nodata)a.canPrint=!0,a.showReportCard=!0,a.report=e.data,a.reportData=null!==e.data.report_data?angular.fromJson(e.data.report_data):[],a.originalData=angular.copy(a.report),a.report.class_name=a.report.class_name,a.report.term=a.report.term_name,a.report.year=a.report.year,a.setReportCardData();else{var f=a.student.student_id+"/"+a.filters["class"].class_id+"/"+a.filters.term_id;d.getExamMarksforReportCard(f,m,o)}};a.setReportCardData=function(b){a.canPrint=!0,a.showReportCard=!0,a.overall=a.reportData.position,a.overallLastTerm=a.reportData.position_last_term,a.total_overall_mark=a.reportData.total_overall_mark,a.totals=a.reportData.totals,a.comments=a.reportData.comments,a.nextTermStartDate=a.reportData.nextTerm};var m=function(b,c){var d=angular.fromJson(b);if("success"==d.response)if(d.details===!1);else if(a.showReportCard=!0,a.examMarks=d.data.details,a.overallSubjectMarks=d.data.subjectOverall,a.overall=d.data.overall,a.overallLastTerm=d.data.overallLastTerm,void 0!==a.reportData);else{a.report.class_name=a.currentFilters["class"].class_name,a.report.term=a.currentFilters.term.term_name,a.report.year=a.currentFilters.term.year,a.reportData={},a.reportData.subjects=[];var e="",f={},g=0;angular.forEach(a.examMarks,function(b,c){b.subject_name!=e&&(g>0&&(a.reportData.subjects[g-1].marks=f),a.reportData.subjects.push({subject_name:b.subject_name}),f={},g++),f[b.exam_type]={mark:b.mark,grade_weight:b.grade_weight,position:b.rank,grade:b.grade},e=b.subject_name}),a.reportData.subjects[g-1].marks=f;var h=0,i=0;a.total_overall_mark=0,angular.forEach(a.reportData.subjects,function(b,c){var d=a.overallSubjectMarks.filter(function(a){return b.subject_name==a.subject_name?a:void 0})[0];return b.overall_mark=d.percentage,b.overall_grade=d.grade,b.position=d.rank,h+=parseInt(d.total_mark),i+=parseInt(d.total_grade_weight),b}),a.total_overall_mark+=Math.round(h/i*100),a.totals={},angular.forEach(a.reportData.subjects,function(b,c){angular.forEach(b.marks,function(b,c){void 0===a.totals[c]&&(a.totals[c]={total_mark:0,total_grade_weight:0}),a.totals[c].total_mark+=b.mark,a.totals[c].total_grade_weight+=b.grade_weight})})}};a.updateReport=function(){a.canPrint=!1,a.modified=!0},a.print=function(){var b={student:a.student,report:a.report,overall:a.overall,overallLastTerm:a.overallLastTerm,examTypes:a.examTypes,reportData:a.reportData,totals:a.totals,comments:a.comments,nextTermStartDate:a.nextTermStartDate,total_overall_mark:a.total_overall_mark},c=window.location.host,d=window.open("http://"+c+"/#/exams/report_card/print");d.printCriteria=b},a.cancel=function(){c.dismiss("canceled")},a.save=function(){a.reportData.position=a.overall,a.reportData.position_last_term=a.overallLastTerm,a.reportData.totals=a.totals,a.reportData.total_overall_mark=a.total_overall_mark,a.reportData.comments=a.comments,a.reportData.nextTerm=a.nextTermStartDate;var c={user_id:b.currentUser.user_id,student_id:a.student.student_id,term_id:a.currentFilters.term.term_id,class_id:a.currentFilters["class"].class_id,report_data:JSON.stringify(a.reportData)};d.addReportCard(c,n,o)};var n=function(c,d,e){var f=angular.fromJson(c);if("success"==f.response){a.canPrint=!0,a.saved=!0,a.modified=!1;var g=a.edit?"Report Card was updated.":"Report Card was added.";b.$emit("reportCardAdded",{msg:g,clear:!0})}else a.error=!0,a.errMsg=f.data},o=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("feeItemFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.classCatSelection=[],a.edit=void 0!==f,a.item=void 0!==f?f:{},a.initializeController=function(){var c=b.currentUser.settings.Frequencies;a.frequencies=c.split(","),a.edit?(a.item.default_amount=parseFloat(f.default_amount_raw),a.classCatSelection=f.class_cats_restriction||[],a.isTransport="Transport"==f.fee_item,a.isTransport&&d.getTansportRoutes({},function(b){var c=angular.fromJson(b);"success"==c.response&&(void 0!==c.nodata?a.transportRoutes=[]:a.transportRoutes=c.data.map(function(a){return a.amount=parseFloat(a.amount),a}))},function(){})):(a.item.optional=!1,a.item.new_student_only=!1,a.item.replaceable=!1)},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.toggleClassCat=function(b){var c=a.classCatSelection.indexOf(b);c>-1?a.classCatSelection.splice(c,1):a.classCatSelection.push(b)},a.save=function(c){if(!c.$invalid){var e=a.item;if(e.new_student_only=e.new_student_only?"t":"f",e.optional=e.optional?"t":"f",e.replaceable=e.replaceable?"t":"f",e.class_cats_restriction=a.classCatSelection,e.user_id=b.currentUser.user_id,a.edit)if(a.isTransport){var f={user_id:b.currentUser.user_id,routes:a.transportRoutes};d.updateRoutes(f,function(b,c){var f=angular.fromJson(b);"success"==f.response?d.updateFeeItem(e,g,h):(a.error=!0,a.errMsg=f.data)},h)}else d.updateFeeItem(e,g,h);else d.addFeeItem(e,g,h)}};var g=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Fee Item  was updated.":"Fee Item  was added.";b.$emit("feeItemAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.deleteFeeItem=function(){var c={user_id:b.currentUser.user_id,fee_item_id:a.item.fee_item_id,status:"f"};d.setFeeItemStatus(c,g,h)},a.activateFeeItem=function(){var c={user_id:b.currentUser.user_id,fee_item_id:a.item.fee_item_id,status:"t"};d.setFeeItemStatus(c,g,h)},a.addRoute=function(){a.transportRoutes.push({transport_id:void 0,route:void 0,amount:void 0})},a.removeRoute=function(b){a.transportRoutes.splice(b,1)}}]),angular.module("eduwebApp").controller("feeStructureCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.alert={},a.currency=b.currentUser.settings.Currency;var g=function(){h()};d(g,1);var h=function(){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),c.getFeeItems({},function(c,e,g){var h=angular.fromJson(c);"success"==h.response?(a.items=h.nodata?[]:h.data.required_items.concat(h.data.optional_items),a.items.length>0&&(a.items=a.items.map(function(a){if(null!==a.class_cats_restriction&&"{}"!=a.class_cats_restriction){var c=a.class_cats_restriction.slice(1,-1);a.class_cats_restriction=c.split(","),a.class_categories=[],angular.forEach(a.class_cats_restriction,function(c,d){angular.forEach(b.classCats,function(b,d){c==b.class_cat_id&&a.class_categories.push(b.class_cat_name)}),a.class_cats_restriction[d]=parseInt(c)})}else a.class_categories="All",a.class_cats_restriction=[];return a.new_student=a.new_student_only?"Yes":"-",a.default_amount_raw=a.default_amount,"Transport"==a.fee_item?a.default_amount=a.range:a.default_amount=f("currency")(a.default_amount,""),a})),d(i,10)):(a.error=!0,a.errMsg=h.data)},j)},i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[1,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No student balances found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",0)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addFeeItem=function(){a.openModal("fees","feeItemForm","md")},a.viewFeeItem=function(b){a.openModal("fees","feeItemForm","md",b)},a.exportItems=function(){b.wipNotice()},a.$on("refreshItems",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h()},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("feesDashboardCtrl",["$scope","$rootScope","apiService","$timeout","$window",function(a,b,c,d,e){var f=moment().subtract(30,"days").format("YYYY-MM-DD"),g=moment().add(1,"day").format("YYYY-MM-DD");a.date={startDate:f,endDate:g},a.currency=b.currentUser.settings.Currency;var h=function(){c.getCurrentTerm({},function(b){var c=angular.fromJson(b);if("success"==c.response){a.currentTerm=c.data,a.currentTermTitle=a.currentTerm.term_name+" "+a.currentTerm.year;var d=moment().add(1,"day").format("YYYY-MM-DD");a.date={startDate:a.currentTerm.start_date,endDate:d},i(a.currentTerm.start_date,d)}},r);var b=moment().startOf("month").format("YYYY-MM-DD"),d=moment().endOf("month").format("YYYY-MM-DD");k(b,d),m(),o()};d(h,1);var i=function(a,b){var d=a+"/"+b+"/false";c.getPaymentsReceived(d,j,r)},j=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.paymentsReceived=d.data,a.paymentsReceivedTotal=0,d.data instanceof Array&&(a.paymentsReceivedTotal=d.data.reduce(function(a,b){return a+=parseFloat(b.amount)},0)),setTimeout(function(){var a={table:"paymentsReceivedTable",sortOrder:[1,"desc"],noResultsTxt:"No payments received were found for selected date range."};q(a)},100)):(a.prError=!0,a.prErrMsg=d.data)},k=function(a,b){var d=a+"/"+b;c.getPaymentsDue(d,l,r)},l=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.paymentsDue=d.data,a.paymentsDueTotal=0,d.data instanceof Array&&(a.paymentsDueTotal=d.data.reduce(function(a,b){return a+=parseFloat(b.amount)},0)),setTimeout(function(){var a={table:"paymentsDueTable",sortOrder:[1,"desc"],noResultsTxt:"No unpaid invoices were found for this month."};q(a)},100)):(a.prError=!0,a.prErrMsg=d.data)},m=function(){c.getPaymentsPastDue({},n,r)},n=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.paymentsPastDue=d.data,a.paymentsPastDueTotal=0,d.data instanceof Array&&(a.paymentsPastDueTotal=d.data.reduce(function(a,b){return a+=parseFloat(b.balance)},0)),setTimeout(function(){var a={table:"paymentsPastDueTable",sortOrder:[1,"desc"],noResultsTxt:"No past invoices were found."};q(a)},100)):(a.prError=!0,a.prErrMsg=d.data)},o=function(){c.getTotalsForTerm({},p,r)},p=function(b,c){var d=angular.fromJson(b);"success"==d.response?a.totals=d.data:(a.prError=!0,a.prErrMsg=d.data)},q=function(c){var d=$("#"+c.table);a.dataGrid=d.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:c.sortOrder,filter:!0,info:!1,sorting:[],scrollY:"200px",initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:c.noResultsTxt}})};a.viewPayment=function(b){a.openModal("fees","paymentDetails","lg",b)},a.viewStudent=function(b){a.openModal("students","viewStudent","lg",b)},a.addPayment=function(){a.openModal("fees","paymentForm","lg",{})},a.adjustPayment=function(){a.openModal("fees","paymentDetails","lg",{})};var r=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("invoiceDetailsCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$parse",function(a,b,c,d,e,f,g){a.invoice=f,a.date={startDate:a.invoice.inv_date},a.due_date={startDate:a.invoice.due_date},a.currency=b.currentUser.settings.Currency,a.edit=void 0!==a.permissions.fees.invoices.edit?a.permissions.fees.invoices.edit:!1;var h=void 0;a.totals={},a.totals.balance=angular.copy(a.invoice.balance),a.totals.total_due=angular.copy(a.invoice.total_due),0==a.invoice.balance&&a.invoice.total_paid>0&&(a.edit=!1),a.$watch("invoice.newItem",function(b,c){if(b!=c){var d=a.invoiceLineItems.length-1;a.invoiceLineItems[d]=b,a.sumInvoice()}}),a.initializeController=function(){d.getInvoiceDetails(a.invoice.inv_id,function(b){var c=angular.fromJson(b);"success"==c.response?(a.invoiceLineItems=c.nodata?{}:c.data,h=angular.copy(a.invoiceLineItems)):(a.error=!0,a.errMsg=c.data)},function(){})},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.cancelInvoice=function(){var c=e.confirm("Cancel Invoice","Are you sure you want to mark this invoice as <strong>canceled</strong>?",{size:"sm"});c.result.then(function(c){var e={user_id:a.currentUser.user_id,inv_id:a.invoice.inv_id};d.cancelInvoice(e,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.invoice.canceled=!0,b.$emit("invoiceAdded",{msg:"Invoice canceled.",clear:!0}))},j)})},a.reactivateInvoice=function(){var c=e.confirm("Activate Invoice","Are you sure you want to mark this invoice as <strong>active</strong>?",{size:"sm"});c.result.then(function(c){var e={user_id:a.currentUser.user_id,inv_id:a.invoice.inv_id};d.reactivateInvoice(e,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.invoice.canceled=!1,b.$emit("invoiceAdded",{msg:"Invoice activated.",clear:!0}))},j)})},a.removeLineItem=function(b){a.invoiceLineItems.splice(b,1),a.sumInvoice(),a.changes=!0},a.revertInvoice=function(b){a.invoiceLineItems=h,a.sumInvoice(),a.changes=!1},a.sumInvoice=function(){a.totals.total_due=a.invoiceLineItems.reduce(function(a,b){return a+=parseFloat(b.amount)},0),a.totals.balance=a.invoice.total_paid-a.totals.total_due,a.changes=!0},a.addRow=function(b){(void 0===a.studentFeeItems||b)&&d.getStudentFeeItems(a.invoice.student_id,function(b,c){var d=angular.fromJson(b);"success"==d.response&&(a.studentFeeItems=angular.copy(d.data))},j),a.invoiceLineItems.push({fee_item:void 0,amount:void 0})},a.viewStudent=function(b,c){a.removeLineItem(c);var d=window.location.host,f=e.create("http://"+d+"/app/students/viewStudent.html","viewStudentCtrl",b,{size:"lg",backdrop:"static"});f.result.then(function(b){a.addRow(!0)},function(){a.addRow(!0)})},a.save=function(){a.error=!1,a.errMsg="";var b=[];angular.forEach(a.invoiceLineItems,function(a,c){b.push({student_fee_item_id:a.student_fee_item_id,inv_item_id:a.inv_item_id,amount:a.amount})});var c={user_id:a.currentUser.user_id,inv_id:a.invoice.inv_id,total_amount:a.totals.total_due,inv_date:a.invoice.inv_date,due_date:a.invoice.due_date,line_items:b};d.updateInvoice(c,i,j)};var i=function(d,e){var f=angular.fromJson(d);"success"==f.response?(c.close(),b.$emit("invoiceAdded",{msg:"Invoice(s) were created.",clear:!0})):(a.error=!0,a.errMsg=f.data)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("invoiceFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$parse",function(a,b,c,d,e,f,g){a.student={},a.selectedStudent=void 0!==f.selectedStudent?f.selectedStudent:void 0,a.selectStudent=void 0===f.selectedStudent,a.student.selected=a.selectedStudent,a.invoice={},a.invoice.creation_method="automatic",a.currency=b.currentUser.settings.Currency,a.invoice.date={startDate:moment().format("YYYY-MM-DD")},a.invoice.due_date={startDate:moment().add(1,"months").format("YYYY-MM-DD")},a.invoiceLineItems=[],a.totals={},a.alert={},a.initializeController=function(){void 0===a.selectedStudent&&d.getAllStudents(!0,function(c){var d=angular.fromJson(c);"success"==d.response?a.students=d.nodata?{}:b.formatStudentData(d.data):(a.error=!0,a.errMsg=d.data)},function(){})},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.clearSelect=function(b,c){c.stopPropagation();var b=g(b+".selected");b.assign(a,void 0)},a.$watch("student.selected",function(b,c){b!=c&&(a.selectedStudent=a.student.selected)}),a.setManual=function(){a.invoice.creation_method="manual",void 0===a.studentFeeItems&&d.getStudentFeeItems(a.student.selected.student_id,function(b,c){var d=angular.fromJson(b);"success"==d.response&&(a.studentFeeItems=angular.copy(d.data))},j)},a.setAutomatic=function(){a.invoice.creation_method="automatic"},a.viewStudent=function(b){var c=window.location.host,d=e.create("http://"+c+"/app/students/viewStudent.html","viewStudentCtrl",b,{size:"lg",backdrop:"static"});d.result.then(function(b){a.generateInvoice()},function(){a.generateInvoice()})},a.generateInvoice=function(){a.error=!1,a.errMsg="";var b=a.invoice.term+"/"+a.student.selected.student_id;d.generateInvoices(b,h,j)};var h=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.results=d.nodata?[]:d.data,a.invoices=a.results.reduce(function(a,b){return b.amount=b.invoice_amount,void 0===a[b.due_date]&&(a[b.due_date]=[]),a[b.due_date].push(b),a},{}),a.activeInvoice=Object.keys(a.invoices)[0],a.invoiceTotal={},angular.forEach(a.invoices,function(b,c){a.invoiceTotal[c]=b.reduce(function(a,b){return a+=parseFloat(b.amount)},0)}),a.invoiceLineItems=a.invoices[a.activeInvoice],a.totals.balance=a.invoiceTotal[a.activeInvoice]):(a.error=!0,a.errMsg=d.data)};a.getInvoice=function(b){a.activeInvoice=b,a.invoiceLineItems=a.invoices[b],a.totals.balance=a.invoiceTotal[b],a.sumInvoice()},a.$watch("invoice.newItem",function(b,c){if(b!=c){var d=a.invoiceLineItems.length-1;a.invoiceLineItems[d]=b,a.sumInvoice()}}),a.removeLineItem=function(b){a.invoiceLineItems.splice(b,1),a.sumInvoice()},a.sumInvoice=function(){a.totals.balance=a.invoiceLineItems.reduce(function(a,b){return a+=parseFloat(b.amount)},0),"automatic"==a.invoice.creation_method&&(a.invoiceTotal={},angular.forEach(a.invoices,function(b,c){a.invoiceTotal[c]=b.reduce(function(a,b){return a+=parseFloat(b.amount)},0)}))},a.addRow=function(){void 0===a.studentFeeItems&&d.getStudentFeeItems(a.student.selected.student_id,function(b,c){
var d=angular.fromJson(b);"success"==d.response&&(a.studentFeeItems=angular.copy(d.data))},j),a.invoiceLineItems.push({fee_item:void 0,amount:void 0})},a.save=function(){a.error=!1,a.errMsg="";var b={user_id:a.currentUser.user_id,invoices:[]},c=[];"automatic"==a.invoice.creation_method?angular.forEach(a.invoices,function(d,e){c=[],angular.forEach(d,function(a,b){null!==a&&c.push({student_fee_item_id:a.student_fee_item_id,amount:a.amount})}),b.invoices.push({inv_date:moment().format("YYYY-MM-DD"),student_id:a.selectedStudent.student_id,due_date:e,total_amount:a.invoiceTotal[e],line_items:c})}):(angular.forEach(a.invoiceLineItems,function(a,b){null!==a&&c.push({student_fee_item_id:a.student_fee_item_id,amount:a.amount})}),b.invoices.push({inv_date:a.invoice.date.startDate,student_id:a.selectedStudent.student_id,due_date:a.invoice.due_date.startDate,total_amount:a.totals.balance,line_items:c})),d.createInvoice(b,i,j)};var i=function(d,e){var f=angular.fromJson(d);"success"==f.response?(c.close(),b.$emit("invoiceAdded",{msg:"Invoice(s) were created.",clear:!0})):(a.error=!0,a.errMsg=f.data)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("invoiceWizardCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$parse",function(a,b,c,d,e,f,g){a.currency=b.currentUser.settings.Currency,a.initializeController=function(){},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.viewStudent=function(b){var c=window.location.host,d=e.create("http://"+c+"/app/students/viewStudent.html","viewStudentCtrl",b,{size:"lg",backdrop:"static"});d.result.then(function(b){a.generateInvoice()},function(){a.generateInvoice()})},a.generateInvoice=function(){a.error=!1,a.errMsg="";var b=a.invoice.term;d.generateInvoices(b,h,j)};var h=function(b,c){var d=angular.fromJson(b);if("success"==d.response){a.allResults=d.nodata?[]:d.data;var e="",f={};a.results=[];var g=0,h=[],i=[];angular.forEach(a.allResults,function(b,c){c>0&&e!=b.student_id+" "+b.due_date&&(a.results.push({student_id:f.student_id,student_name:f.student_name,due_date:f.due_date,fee_items:h,line_items:i,total_amount:g}),g=0,h=[],i=[]),g+=parseFloat(b.invoice_amount),h.push(b.fee_item),i.push(b),e=b.student_id+" "+b.due_date,f=b}),a.results.push({student_id:f.student_id,student_name:f.student_name,due_date:f.due_date,fee_items:h,line_items:i,total_amount:g}),a.invoices=a.results.reduce(function(a,b){var c=moment(b.due_date).format("MMM");return void 0===a[c]&&(a[c]=[]),a[c].push(b),a},{}),a.activeMonth=Object.keys(a.invoices)[0],a.invoiceTotal={},angular.forEach(a.invoices,function(b,c){a.invoiceTotal[c]=b.reduce(function(a,b){return a=parseInt(a)+parseInt(b.total_amount)},0)})}else a.error=!0,a.errMsg=d.data};a.getInvoice=function(b){a.activeMonth=b},a.save=function(){a.error=!1,a.errMsg="";var b={user_id:a.currentUser.user_id,invoices:[]},c=[];angular.forEach(a.results,function(a,d){c=[],angular.forEach(a.line_items,function(a,b){null!==a&&c.push({student_fee_item_id:a.student_fee_item_id,amount:a.invoice_amount})}),b.invoices.push({inv_date:moment().format("YYYY-MM-DD"),student_id:a.student_id,due_date:a.due_date,total_amount:a.total_amount,line_items:c})}),d.createInvoice(b,i,j)};var i=function(d,e){var f=angular.fromJson(d);"success"==f.response?(c.close(),b.$emit("invoiceAdded",{msg:"Invoice(s) were created.",clear:!0})):(a.error=!0,a.errMsg=f.data)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("invoicesCtrl",["$scope","$rootScope","apiService","$timeout","$window","$state",function(a,b,c,d,e,f){a.filters={},a.filters.status="true",a.filters.balance_status=""!==f.params.balance_status?f.params.balance_status:null,a.filterBalStatus=""!==f.params.balance_status,a.invoices=[],a.filterShowing=!1,a.toolsShowing=!1;var g=!0,h=!1;b.modalLoading=!1,a.alert=null,a.currency=b.currentUser.settings.Currency,a.totals={},a.balanceStatuses=["Balance Owing","Paid in Full","Due This Month","Past Due"];var i=moment().format("YYYY-01-01"),j=moment().format("YYYY-MM-DD");a.date={startDate:i,endDate:j};var k=angular.copy(a.date),l=!1;a.filters.date=a.date;var m=function(){if(void 0===b.allClasses?c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses)},function(){}):a.classes=b.allClasses,void 0===b.terms){var d=moment().format("YYYY");c.getTerms(d,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.terms=d.data,b.terms=d.data,n(d.data))},function(){})}else a.terms=b.terms,n(a.terms);o("true",a.filterBalStatus)};d(m,1);var n=function(b){a.termRanges={},angular.forEach(b,function(b,c){a.termRanges[b.term_year_name]=[b.start_date,b.end_date]})},o=function(b,e){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy());var f=angular.copy(a.filters),g=moment(f.date.startDate).format("YYYY-MM-DD")+"/"+moment(f.date.endDate).format("YYYY-MM-DD")+"/false/"+b;c.getInvoices(g,function(b,c,f){var g=angular.fromJson(b);if("success"==g.response)if(void 0!==g.nodata)a.invoices={},d(q,10);else{k=f.filters.date;var h=g.data;f.filters.status===!1?(a.formerStudents=h,a.invoices=r(h,f.filters)):(a.allStudents=h,a.invoices=e?r(h,f.filters):h),d(q,10)}else a.error=!0,a.errMsg=g.data},function(){},{filters:f})},p=function(){a.totals.total_due=a.invoices.reduce(function(a,b){return a=parseInt(a)+parseInt(b.total_due)},0),a.totals.total_paid=a.invoices.reduce(function(a,b){return a=parseInt(a)+parseInt(b.total_paid)},0),a.totals.total_balance=a.invoices.reduce(function(a,b){return a=parseInt(a)+parseInt(b.balance)},0)},q=function(){a.invoices.length>0&&p();var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[8,"desc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No student balances found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+50)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.$watch("filters.class_cat_id",function(c,d){d!=c&&(void 0===c||""==c?a.classes=b.allClasses:a.classes=b.allClasses.reduce(function(a,b){return b.class_cat_id==c&&a.push(b),a},[]))}),a.$watch("filters.date",function(a,b){a!=b&&(l=a!==k)}),a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.loadFilter=function(){a.loading=!0,h=!0,"false"==a.filters.status&&void 0===a.formerStudents?o("false",!0):l?o(g,!0):(a.invoices=r("false"==a.filters.status?a.formerStudents:a.allStudents,a.filters),d(q,1)),g=a.filters.status};var r=function(b,c){if(void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),void 0!==c.class_cat_id&&null!==c.class_cat_id&&""!==c.class_cat_id&&(b=b.reduce(function(a,b){return b.class_cat_id.toString()==c.class_cat_id.toString()&&a.push(b),a},[])),void 0!==c.class_id&&null!==c.class_id&&""!==c.class_id&&(b=b.reduce(function(a,b){return b.class_id.toString()==c.class_id.toString()&&a.push(b),a},[])),void 0!==c.balance_status&&null!==c.balance_status&&""!==c.balance_status)switch(c.balance_status){case"Balance Owing":b=b.reduce(function(a,b){return b.balance<0&&a.push(b),a},[]);break;case"Paid in Full":b=b.reduce(function(a,b){return b.balance>=0&&a.push(b),a},[]);break;case"Due This Month":var d=moment().startOf("month").format("YYYY-MM-DD"),e=moment().endOf("month").format("YYYY-MM-DD");b=b.reduce(function(a,b){var c=moment(b.due_date).format("YYYY-MM-DD");return c>=d&&e>=c&&a.push(b),a},[]);break;case"Past Due":b=b.reduce(function(a,b){return b.days_overdue>0&&a.push(b),a},[])}return b};a.addInvoice=function(){a.openModal("fees","invoiceForm","lg",{})},a.generateInvoices=function(){a.openModal("fees","invoiceWizard","lg")},a.exportInvoices=function(){b.wipNotice()},a.viewStudent=function(b){a.openModal("students","viewStudent","lg",b)},a.viewInvoice=function(b){a.openModal("fees","invoiceDetails","lg",b)},a.$on("refreshInvoices",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,o(g,h)},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("openingBalancesCtrl",["$scope","$rootScope","apiService","$timeout","$window",function(a,b,c,d,e){a.filters={},a.filters.status="true",a.students=[],a.filterShowing=!1,a.toolsShowing=!1;var f=!0,g=!1;b.modalLoading=!1,a.alert=null,a.currency=b.currentUser.settings.Currency,a.totals={},a.years=[];for(var h=moment().format("YYYY"),i=void 0!==b.currentUser.settings["Initial Year"]?b.currentUser.settings["Initial Year"]:"2014",j=i;h>=j;j++)a.years.push(j);a.filters.year=h;var k=h,l=!1,m=function(){void 0===b.allClasses?c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses)},function(){}):a.classes=b.allClasses,n("true",!1)};d(m,1);var n=function(b,e){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy());var f=angular.copy(a.filters.year),g=f+"/"+b;c.getStudentBalances(g,function(b,c,f){var g=angular.fromJson(b);if("success"==g.response)if(void 0!==g.nodata)a.students=[],d(p,10);else{k=f.year;var h=g.data;e?(a.formerStudents=h,q()):(a.allStudents=h,a.students=h,d(p,10))}else a.error=!0,a.errMsg=g.data},function(){},{year:f})},o=function(){a.totals.total_due=a.students.reduce(function(a,b){return a+=parseFloat(b.total_due)},0),a.totals.total_paid=a.students.reduce(function(a,b){return a+=parseFloat(b.total_paid)},0),a.totals.total_balance=a.students.reduce(function(a,b){return a+=parseFloat(b.balance)},0)},p=function(){o();var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[5,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No student balances found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+40)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.$watch("filters.class_cat_id",function(c,d){d!=c&&(void 0===c||""==c?a.classes=b.allClasses:a.classes=b.allClasses.reduce(function(a,b){return b.class_cat_id==c&&a.push(b),a},[]))}),a.$watch("filters.year",function(a,b){a!=b&&(l=a!==k)}),a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.loadFilter=function(){a.loading=!0,g=!0,"false"==a.filters.status&&void 0===a.formerStudents?n("false",!0):l?n(f,!0):q(),f=a.filters.status};var q=function(){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0);var b="false"==a.filters.status?a.formerStudents:a.allStudents;void 0!==a.filters.class_cat_id&&null!==a.filters.class_cat_id&&""!==a.filters.class_cat_id&&(b=b.reduce(function(b,c){return c.class_cat_id.toString()==a.filters.class_cat_id.toString()&&b.push(c),b},[])),void 0!==a.filters.class_id&&null!==a.filters.class_id&&""!==a.filters.class_id&&(b=b.reduce(function(b,c){return c.class_id.toString()==a.filters.class_id.toString()&&b.push(c),b},[])),a.students=b,d(p,1)};a.addPayment=function(){a.openModal("fees","paymentForm","lg",{})},a.adjustPayment=function(){a.openModal("fees","editPaymentForm","lg",{})},a.viewStudent=function(b){a.openModal("students","viewStudent","lg",b)},a.exportBalances=function(){b.wipNotice()},a.$on("refreshBalances",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,n(f,g)},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("paymentDetailsCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$filter",function(a,b,c,d,e,f,g){a.edit=void 0!==a.permissions.fees.payments_received.edit?a.permissions.fees.payments_received.edit:!1,a.makeSelection=void 0===f.payment_id,a.student={},a.payment={},a.selectedPayment=f||void 0,a.currency=b.currentUser.settings.Currency,a.invoiceSelection=[],a.feeItemsSelection=[],a.feeItemsSelection2=[];var h=function(){var c=b.currentUser.settings["Payment Methods"];a.paymentMethods=c.split(","),void 0!==a.selectedPayment.payment_id?(a.student_name=angular.copy(a.selectedPayment.student_name),a.student_id=angular.copy(a.selectedPayment.student_id),d.getPaymentDetails(a.selectedPayment.payment_id,j,p),d.getStudentBalance(a.student_id,m,p)):d.getAllStudents(!0,function(c){var d=angular.fromJson(c);"success"==d.response?a.students=d.nodata?{}:b.formatStudentData(d.data):(a.error=!0,a.errMsg=d.data)},function(){})};setTimeout(h,1),a.cancel=function(){c.dismiss("canceled")},a.clearSelect=function(b,c){c.stopPropagation();var b=$parse(b+".selected");b.assign(a,void 0)},a.$watch("student.selected",function(b,c){b!=c&&(a.selectedStudent=a.student.selected,a.student_name=angular.copy(a.student.selected.student_name),a.student_id=angular.copy(a.student.selected.student_id),d.getStudentPayments(a.student_id,i,p),a.selectedPayment=void 0)});var i=function(b,c){var d=angular.fromJson(b);"success"==d.response?a.payments=d.nodata?[]:angular.copy(d.data):(a.error=!0,a.errMsg=d.data)};a.$watch("payment.selected",function(b,c){b!=c&&(a.selectedPayment=a.payment.selected,d.getPaymentDetails(a.selectedPayment.payment_id,j,p),d.getStudentBalance(a.student_id,m,p))});var j=function(b,c){var e=angular.fromJson(b);if("success"==e.response){var f=e.nodata?{}:e.data;a.selectedPayment=f.payment,a.selectedInvoice=f.invoice.length>0?l(f.invoice)[0]:void 0,d.getOpenInvoices(a.student_id,k,p),void 0!==a.selectedInvoice&&angular.forEach(a.selectedInvoice.fee_items,function(b,c){angular.forEach(f.paymentItems,function(c,d){b.inv_item_id==c.inv_item_id&&(b.amount=c.line_item_amount,b.payment_inv_item_id=c.payment_inv_item_id,a.feeItemsSelection.push(b))})}),a.selectedPayment.replacement_payment&&d.getReplaceableFeeItems(a.student_id,function(b,c){var d=angular.fromJson(b);"success"==d.response&&(a.replaceableFeeItems=angular.copy(d.data),angular.forEach(a.replaceableFeeItems,function(b,c){angular.forEach(f.paymentItems,function(c,d){b.student_fee_item_id==c.inv_item_id&&(b.paying_amount=c.line_item_amount,b.payment_replace_item_id=c.payment_inv_item_id,a.feeItemsSelection2.push(b))})}))},p)}else a.error=!0,a.errMsg=e.data},k=function(b,c){a.loading=!1;var d=angular.fromJson(b);"success"==d.response&&(a.invoices=d.nodata?[]:l(angular.copy(d.data)))},l=function(b){var c={},d={},e=[],f=[];return angular.forEach(b,function(b,e){e>0&&c!=b.inv_id&&(a.invoices.push({inv_id:d.inv_id,inv_date:d.inv_date,due_date:d.due_date,balance:d.balance,total_due:d.total_due,fee_items:f}),f=[]),f.push({fee_item_id:b.fee_item_id,fee_item:b.fee_item,balance:b.line_item_amount,inv_item_id:b.inv_item_id,amount:null}),c=b.inv_id,d=b}),e.push({inv_id:d.inv_id,inv_date:d.inv_date,due_date:d.due_date,balance:d.balance,total_due:d.total_due,fee_items:f}),e},m=function(b,c){a.loading=!1;var d=angular.fromJson(b);void 0!==a.dataGrid&&(a.dataGrid.clear(),a.dataGrid.destroy()),"success"==d.response&&(void 0===d.nodata?(a.feeSummary=angular.copy(d.data.fee_summary),a.fees=angular.copy(d.data.fees),a.nofeeSummary=!1):(a.feeSummary=[],a.fees=[],a.nofeeSummary=!0),setTimeout(n,50))},n=function(){var a={sortOrder:[4,"asc"],noResultsTxt:"This student has not been invoiced."};o(a)},o=function(c){var d=$("#resultsTable3");a.dataGrid=d.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:c.sortOrder,filter:!1,info:!1,sorting:[],scrollY:"200px",initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{lengthMenu:"Display _MENU_",emptyTable:c.noResultsTxt}})};a.changeInvoice=function(b){a.changingInvoice=b,b||(a.selectedNewInvoice=void 0)},a.unapplyInvoice=function(){a.selectedPayment.inv_id=void 0,a.selectedInvoice=void 0,a.changeInvoice(!1)},a.$watch("selectedPayment.apply_to_all",function(b,c){b!=c&&(a.selectedNewInvoice?b?angular.forEach(a.selectedNewInvoice.fee_items,function(b,c){b.amount=b.balance,a.feeItemsSelection.push(b)}):angular.forEach(a.selectedNewInvoice.fee_items,function(b,c){b.amount=void 0,a.feeItemsSelection=[]}):b?angular.forEach(a.selectedInvoice.fee_items,function(b,c){b.amount=b.balance,a.feeItemsSelection.push(b)}):angular.forEach(a.selectedInvoice.fee_items,function(b,c){b.amount=void 0,a.feeItemsSelection=[]}))}),a.$watch("selectedPayment.replacement_payment",function(a,b){}),a.viewStudent=function(b){var c=window.location.host,d=e.create("http://"+c+"/app/students/viewStudent.html","viewStudentCtrl",b,{size:"lg",backdrop:"static"});d.result.then(function(b){a.generateInvoice()},function(){a.generateInvoice()})};var p=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.$watch("selectedPayment.invoice",function(b,c){b!=c&&(a.selectedNewInvoice=b)}),a.toggleFeeItems=function(b){var c=a.feeItemsSelection.indexOf(b);c>-1?(b.amount=void 0,a.feeItemsSelection.splice(c,1)):(b.amount=b.balance,a.feeItemsSelection.push(b))},a.toggleFeeItems2=function(b){var c=a.feeItemsSelection2.indexOf(b);c>-1?(b.paying_amount=void 0,a.feeItemsSelection2.splice(c,1)):(b.paying_amount=b.amount,a.feeItemsSelection2.push(b))},a.save=function(){var b=a.feeItemsSelection.reduce(function(a,b){return a+=parseFloat(b.amount)},0);if(a.selectedPayment.replacement_payment!==!0)if(b>a.selectedPayment.amount)var c=e.error("Amount Inconsistency","<p>You have entered <strong>"+g("number")(b)+" Ksh</strong> towards fee items, however to total payment amount enterd was <strong>"+g("number")(a.selectedPayment.amount)+" Ksh</strong>.</p><p>Please correct, the total amount applied to fee items can not exceed the total payment amount.</p>",{size:"sm"});else if(b<a.selectedPayment.amount){var c=e.confirm("Unapplied Payment","<p>You have <strong>"+g("number")(a.selectedPayment.amount-b)+" Ksh</strong> that has not been applied to fee items, do you wish to continue?</p>",{size:"sm"});c.result.then(function(a){q()},function(a){})}else q();else q()};var q=function(){if(a.error=!1,a.errMsg="",a.selectedPayment.replacement_payment){var b=[];angular.forEach(a.feeItemsSelection2,function(a,c){b.push({payment_replace_item_id:a.payment_replace_item_id,student_fee_item_id:a.student_fee_item_id,amount:a.paying_amount})});var c={user_id:a.currentUser.user_id,payment_id:a.selectedPayment.payment_id,student_id:a.student_id,payment_date:moment(a.selectedPayment.payment_date.startDate).format("YYYY-MM-DD"),amount:a.selectedPayment.amount,payment_method:a.selectedPayment.payment_method,slip_cheque_no:a.selectedPayment.slip_cheque_no,replacement_payment:a.selectedPayment.replacement_payment?"t":"f",inv_id:void 0!==a.selectedPayment.invoice?a.selectedPayment.invoice.inv_id:void 0!==a.selectedInvoice?a.selectedInvoice.inv_id:null,replacement_items:b}}else{var e=[];angular.forEach(a.feeItemsSelection,function(a,b){e.push({payment_inv_item_id:a.payment_inv_item_id,inv_item_id:a.inv_item_id,amount:a.amount})});var c={user_id:a.currentUser.user_id,payment_id:a.selectedPayment.payment_id,student_id:a.student_id,payment_date:moment(a.selectedPayment.payment_date.startDate).format("YYYY-MM-DD"),amount:a.selectedPayment.amount,payment_method:a.selectedPayment.payment_method,slip_cheque_no:a.selectedPayment.slip_cheque_no,replacement_payment:"true"==a.selectedPayment.replacement_payment?"t":"f",inv_id:void 0!==a.selectedPayment.invoice?a.selectedPayment.invoice.inv_id:void 0!==a.selectedInvoice?a.selectedInvoice.inv_id:null,line_items:e}}d.updatePayment(c,r,p)};a.reversePayment=function(){var c=e.confirm("Reverse Payment","Are you sure you want to revers this payment?",{size:"sm"});c.result.then(function(c){var e={user_id:a.currentUser.user_id,payment_id:a.selectedPayment.payment_id};d.reversePayment(e,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.selectedPayment.reversed=!0,b.$emit("paymentAdded",{msg:"Payment reversed.",clear:!0}))},p)})},a.reactivatePayment=function(){var c=e.confirm("Activate Payment","Are you sure you want to mark this payment as <strong>active</strong>?",{size:"sm"});c.result.then(function(c){var e={user_id:a.currentUser.user_id,payment_id:a.selectedPayment.payment_id};d.reactivatePayment(e,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.selectedPayment.reversed=!1,b.$emit("paymentAdded",{msg:"Payment activated.",clear:!0}))},p)})};var r=function(d,e){var f=angular.fromJson(d);"success"==f.response?(c.close(),b.$emit("paymentAdded",{msg:"Payment was added.",clear:!0})):(a.error=!0,a.errMsg=f.data)}}]),angular.module("eduwebApp").controller("paymentFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data","$filter","$parse",function(a,b,c,d,e,f,g,h){a.student={},a.selectedStudent=void 0!==f.selectedStudent?f.selectedStudent:void 0,a.showSelect=void 0===f.selectedStudent,a.student.selected=a.selectedStudent,a.payment={},a.payment.payment_date={startDate:moment().format("YYYY-MM-DD")},a.payment.replacement_payment=!1,a.currency=b.currentUser.settings.Currency,a.invoiceSelection=[],a.feeItemsSelection=[],a.feeItemsSelection2=[];var i=function(){var c=b.currentUser.settings["Payment Methods"];a.paymentMethods=c.split(","),void 0===a.selectedStudent?d.getAllStudents(!0,function(c){var d=angular.fromJson(c);"success"==d.response?a.students=d.nodata?{}:b.formatStudentData(d.data):(a.error=!0,a.errMsg=d.data)},function(){}):(d.getOpenInvoices(a.selectedStudent.student_id,j,o),d.getStudentBalance(a.selectedStudent.student_id,l,o))};setTimeout(i,1),a.cancel=function(){c.dismiss("canceled")},a.clearSelect=function(b,c){c.stopPropagation();var b=h(b+".selected");b.assign(a,void 0)},a.$watch("student.selected",function(b,c){b!=c&&(a.selectedStudent=a.student.selected,d.getOpenInvoices(a.student.selected.student_id,j,o),d.getStudentBalance(a.student.selected.student_id,l,o))}),a.$watch("payment.apply_to_all",function(b,c){b!=c&&(b?angular.forEach(a.selectedInvoice.fee_items,function(b,c){b.amount=b.balance,a.feeItemsSelection.push(b)}):angular.forEach(a.selectedInvoice.fee_items,function(b,c){b.amount=void 0,a.feeItemsSelection=[]}))}),a.$watch("payment.replacement_payment",function(b,c){b!=c&&d.getReplaceableFeeItems(a.selectedStudent.student_id,function(b,c){var d=angular.fromJson(b);"success"==d.response&&(a.replaceableFeeItems=angular.copy(d.data))},o)}),a.viewStudent=function(b){var c=window.location.host,d=e.create("http://"+c+"/app/students/viewStudent.html","viewStudentCtrl",b,{size:"lg",backdrop:"static"});d.result.then(function(b){a.generateInvoice()},function(){a.generateInvoice()})};var j=function(b,c){a.loading=!1;var d=angular.fromJson(b);"success"==d.response&&(a.invoices=k(angular.copy(d.data)))},k=function(a){var b={},c={},d=[],e=[];return angular.forEach(a,function(a,f){f>0&&b!=a.inv_id&&(d.push({inv_id:c.inv_id,inv_date:c.inv_date,due_date:c.due_date,balance:c.balance,fee_items:e}),e=[]),e.push({fee_item_id:a.fee_item_id,fee_item:a.fee_item,balance:a.line_item_amount,inv_item_id:a.inv_item_id,amount:null}),b=a.inv_id,c=a}),d.push({inv_id:c.inv_id,inv_date:c.inv_date,due_date:c.due_date,balance:c.balance,fee_items:e}),d},l=function(b,c){a.loading=!1;var d=angular.fromJson(b);void 0!==a.dataGrid&&(a.dataGrid.clear(),a.dataGrid.destroy()),"success"==d.response&&(void 0===d.nodata?(a.feeSummary=angular.copy(d.data.fee_summary),a.fees=angular.copy(d.data.fees),a.nofeeSummary=!1):(a.feeSummary=[],a.fees=[],a.nofeeSummary=!0),setTimeout(m,50))},m=function(){var a={sortOrder:[4,"asc"],noResultsTxt:"This student has not been invoiced."};n(a)},n=function(c){var d=$("#resultsTable2");a.dataGrid=d.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:c.sortOrder,filter:!1,info:!1,sorting:[],scrollY:"200px",initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{lengthMenu:"Display _MENU_",emptyTable:c.noResultsTxt}})},o=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.$watch("payment.invoice",function(b,c){b!=c&&(a.selectedInvoice=b)}),a.toggleFeeItems=function(b){var c=a.feeItemsSelection.indexOf(b);c>-1?(b.amount=void 0,a.feeItemsSelection.splice(c,1)):(b.amount=b.balance,a.feeItemsSelection.push(b))},a.toggleFeeItems2=function(b){var c=a.feeItemsSelection2.indexOf(b);c>-1?(b.paying_amount=void 0,a.feeItemsSelection2.splice(c,1)):(b.paying_amount=b.amount,a.feeItemsSelection2.push(b))},a.save=function(){var b=a.feeItemsSelection.reduce(function(a,b){return a+=parseFloat(b.amount)},0);if(a.payment.replacement_payment!==!0)if(b>a.payment.amount)var c=e.error("Amount Inconsistency","<p>You have entered <strong>"+g("number")(b)+" Ksh</strong> towards fee items, however to total payment amount enterd was <strong>"+g("number")(a.payment.amount)+" Ksh</strong>.</p><p>Please correct, the total amount applied to fee items can not exceed the total payment amount.</p>",{size:"sm"});else if(b<a.payment.amount){var c=e.confirm("Unapplied Payment","<p>You have <strong>"+g("number")(a.payment.amount-b)+" Ksh</strong> that has not been applied to fee items, do you wish to continue?</p>",{size:"sm"});c.result.then(function(a){p()},function(a){})}else p();else p()};var p=function(){if(a.error=!1,a.errMsg="",a.payment.replacement_payment){var b=[];angular.forEach(a.feeItemsSelection2,function(a,c){b.push({student_fee_item_id:a.student_fee_item_id,amount:a.paying_amount})});var c={user_id:a.currentUser.user_id,student_id:a.selectedStudent.student_id,payment_date:moment(a.payment.payment_date.startDate).format("YYYY-MM-DD"),amount:a.payment.amount,payment_method:a.payment.payment_method,slip_cheque_no:a.payment.slip_cheque_no,replacement_payment:a.payment.replacement_payment?"t":"f",inv_id:void 0!==a.payment.invoice?a.payment.invoice.inv_id:null,replacement_items:b}}else{var e=[];angular.forEach(a.feeItemsSelection,function(a,b){e.push({inv_item_id:a.inv_item_id,amount:a.amount})});var c={user_id:a.currentUser.user_id,student_id:a.selectedStudent.student_id,payment_date:moment(a.payment.payment_date.startDate).format("YYYY-MM-DD"),amount:a.payment.amount,payment_method:a.payment.payment_method,slip_cheque_no:a.payment.slip_cheque_no,replacement_payment:"true"==a.payment.replacement_payment?"t":"f",inv_id:a.payment.invoice.inv_id,line_items:e}}d.addPayment(c,q,o)},q=function(d,e){var f=angular.fromJson(d);"success"==f.response?(c.close(),b.$emit("paymentAdded",{msg:"Payment was added.",clear:!0})):(a.error=!0,a.errMsg=f.data)}}]),angular.module("eduwebApp").controller("paymentsReceivedCtrl",["$scope","$rootScope","apiService","$timeout","$window",function(a,b,c,d,e){a.filters={},a.filters.status="true",a.filterShowing=!1,a.toolsShowing=!1;var f=!1;b.modalLoading=!1,a.alert={},a.currency=b.currentUser.settings.Currency,a.totals={},a.paymentStatuses=[{value:"false",label:"Good"},{value:"true",label:"Reversed"}],a.filters.payment_status="false";var g=moment().format("YYYY-01-01"),h=moment().format("YYYY-MM-DD");a.date={startDate:g,endDate:h};var i=angular.copy(a.date),j=!1;a.filters.date=a.date;var k=function(){if(void 0===b.allClasses?c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses)},function(){}):a.classes=b.allClasses,void 0===b.terms){var d=moment().format("YYYY");c.getTerms(d,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.terms=d.data,b.terms=d.data,l(d.data))},function(){})}else a.terms=b.terms,l(a.terms);m(!1)};d(k,1);var l=function(b){a.termRanges={},angular.forEach(b,function(b,c){a.termRanges[b.term_year_name]=[b.start_date,b.end_date]})},m=function(b){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy());var e=angular.copy(a.filters),f=moment(e.date.startDate).format("YYYY-MM-DD")+"/"+moment(e.date.endDate).format("YYYY-MM-DD")+"/"+e.payment_status;""!=status&&(f+="/"+e.status),c.getPaymentsReceived(f,function(c,e,f){var g=angular.fromJson(c);if("success"==g.response)if(void 0!==g.nodata)a.payments={},d(o,10);else{i=f.filters.date;var h=g.data;"true"==f.filters.payment_status?(a.reversedPayments=h,a.payments=p(h,f.filters)):(a.allPayments=h,a.payments=b?p(h,f.filters):h),a.payments=h.map(function(a){return a.replacement=a.replacement_payment?"Yes":"No",a.reverse=a.reversed?"Yes":"No",a}),d(o,10)}else a.error=!0,a.errMsg=g.data},function(){},{filters:e})},n=function(){a.totals.total_paid=a.payments.reduce(function(a,b){return a+=parseFloat(b.amount)},0)},o=function(){a.payments.length>0&&n();var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[4,"desc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No student balances found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+50)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.$watch("filters.class_cat_id",function(c,d){d!=c&&(void 0===c||""==c?a.classes=b.allClasses:a.classes=b.allClasses.reduce(function(a,b){return b.class_cat_id==c&&a.push(b),a},[]))}),a.$watch("filters.date",function(a,b){a!=b&&(j=a!==i)}),a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){
$("#resultsTable_filter").show()},500)},a.loadFilter=function(){a.loading=!0,f=!0,"true"==a.filters.payment_status&&void 0===a.reversedPayments?m(!0):j?m(!0):(a.payments=p("true"==a.filters.payment_status?a.reversedPayments:a.allPayments,a.filters),d(o,1))};var p=function(b,c){return void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),void 0!==c.class_cat_id&&null!==c.class_cat_id&&""!==c.class_cat_id&&(b=b.reduce(function(a,b){return b.class_cat_id.toString()==c.class_cat_id.toString()&&a.push(b),a},[])),void 0!==c.class_id&&null!==c.class_id&&""!==c.class_id&&(b=b.reduce(function(a,b){return b.class_id.toString()==c.class_id.toString()&&a.push(b),a},[])),void 0!==c.status&&null!==c.status&&""!==c.status&&(b=b.reduce(function(a,b){return b.status.toString()==c.status.toString()&&a.push(b),a},[])),b};a.addPayment=function(){a.openModal("fees","paymentForm","lg",{})},a.adjustPayment=function(){a.openModal("fees","adjustPaymentForm","lg",{})},a.exportPayments=function(){b.wipNotice()},a.viewStudent=function(b){a.openModal("students","viewStudent","lg",b)},a.viewPayment=function(b){a.openModal("fees","paymentDetails","lg",b)},a.adjustPayment=function(){a.openModal("fees","paymentDetails","lg",{})},a.getReceipt=function(d){c.getStudentDetails(d.student_id,function(e){var f=angular.fromJson(e);if("success"==f.response){var g=b.formatStudentData([f.data]),h=b.allClasses.filter(function(a){return a.class_id==g[0].class_id?a:void 0});g[0].current_class=h[0],a.student=g[0],c.getFeeItems({},function(b){var c=angular.fromJson(b);if("success"==c.response){a.feeItems=q(c.data.required_items),a.feeItems=r(a.feeItems),a.optFeeItems=q(c.data.optional_items),a.optFeeItems=r(a.optFeeItems);var e={student:a.student,payment:d,feeItems:a.feeItems.concat(a.optFeeItems)};a.openModal("fees","receipt","md",e)}},function(){})}})};var q=function(a){return a.map(function(a){if(null!==a.class_cats_restriction&&"{}"!=a.class_cats_restriction){var b=a.class_cats_restriction.slice(1,-1);a.class_cats_restriction=b.split(",")}return a.amount=void 0,a.payment_method=void 0,a})},r=function(b){var c=[];return c=a.student.new_student?b:b.filter(function(a){return a.new_student_only?void 0:a}),void 0!==a.student.current_class&&(c=c.filter(function(b){return null===b.class_cats_restriction||"{}"==b.class_cats_restriction?b:b.class_cats_restriction.indexOf(a.student.current_class.class_cat_id.toString())>-1?b:void 0})),c};a.$on("refreshPayments",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,m(f)},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("printReceiptCtrl",["$scope","$rootScope",function(a,b){var c=function(){var c=window.printCriteria;a.student=angular.fromJson(c.student),a.payment=angular.fromJson(c.payment),a.feeItems=angular.fromJson(c.feeItems),a.paymentItems=angular.fromJson(c.paymentItems),a.totalAmtKsh=c.totals.totalAmtKsh,a.totalAmtCts=c.totals.totalAmtCts,a.balanceDue=c.totals.balanceDue,a.loading=!1,setTimeout(function(){window.print(),setTimeout(function(){b.isPrinting=!1,window.close()},100)},100)};setTimeout(c,1),a.$on("$destroy",function(){b.isPrinting=!1})}]),angular.module("eduwebApp").controller("receiptCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.payment=e.payment,a.student=e.student,a.feeItems=e.feeItems;var f=function(){d.getPaymentDetails(a.payment.payment_id,g,h)};setTimeout(f,1),a.cancel=function(){c.dismiss("canceled")};var g=function(b,c){var d=angular.fromJson(b);if("success"==d.response){var e=d.nodata?{}:d.data;a.paymentDetails=e.paymentItems;var f=e.invoice;a.paymentItems=[];var g,h=0;angular.forEach(a.paymentDetails,function(b,c){g=b.line_item_amount.split("."),a.paymentItems[b.fee_item]={ksh:g[0],cts:g[1]},h+=parseFloat(b.line_item_amount)});var g=String(h).indexOf(".")>-1?String(h).split("."):[h,"00"];if(a.totalAmtKsh=g[0],a.totalAmtCts=g[1],f.length>0){var i=f[0].total_due;a.balanaceDue=i-a.payment.amount}}else a.error=!0,a.errMsg=d.data};a.print=function(){var b={student:a.student,payment:a.payment,paymentItems:a.paymentItems,totals:{totalAmtKsh:a.totalAmtKsh,totalAmtCts:a.totalAmtCts,balanceDue:a.balanceDue},feeItems:a.feeItems},c=window.location.host,d=window.open("http://"+c+"/#/fees/receipt/print");d.printCriteria=b};var h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("classFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.theClass=void 0!==f?f:{},a.edit=void 0!==a.theClass.class_id,a.subjectSelection=[],a.subjectExamSelection={},a.apply_to_all_subjects=[],a.gradeWeight={};var g=function(b){d.getSubjects(b,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.subjects=c.nodata?[]:c.data)},k)},h=function(b){d.getClassExams(b,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.classDetails=c.nodata?[]:angular.copy(c.data),angular.forEach(a.classDetails,function(b,c){-1===a.subjectSelection.indexOf(b.subject_id)&&a.subjectSelection.push(b.subject_id),void 0===a.subjectExamSelection[b.subject_id]&&(a.subjectExamSelection[b.subject_id]=[]),a.subjectExamSelection[b.subject_id].push(b.exam_type_id),void 0===a.gradeWeight[b.subject_id+"-"+b.exam_type_id]&&(a.gradeWeight[b.subject_id+"-"+b.exam_type_id]={}),a.gradeWeight[b.subject_id+"-"+b.exam_type_id].grade_weight=b.grade_weight}),g(a.theClass.class_cat_id),d.getExamTypes(a.theClass.class_cat_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data)},k))},k)},i=function(){d.getAllTeachers(!0,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.teachers=c.data)},k),a.edit&&h(a.theClass.class_id)};setTimeout(i,1),a.$watch("theClass.class_cat_id",function(b,c){b!=c&&(g(b),d.getExamTypes(b,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data)},k))}),a.cancel=function(){c.dismiss("canceled")},a.save=function(c){if(!c.$invalid){var e=a.theClass;e.user_id=b.currentUser.user_id,e.subjects=[],a.edit?(angular.forEach(a.subjectSelection,function(b,c){var d=[];angular.forEach(a.subjectExamSelection[b],function(c,e){if(void 0!==a.classDetails)var f=a.classDetails.filter(function(a){return a.subject_id==b&&a.exam_type_id==c?a:void 0})[0];d.push({exam_type_id:c,class_subject_id:void 0!==f?f.class_subject_id:void 0,class_sub_exam_id:void 0!==f?f.class_sub_exam_id:void 0,grade_weight:void 0!==a.gradeWeight[b+"-"+c]?a.gradeWeight[b+"-"+c].grade_weight:0})}),e.subjects.push({subject_id:b,exams:d})}),d.updateClass(e,j,k)):(angular.forEach(a.subjectSelection,function(b,c){var d=[];angular.forEach(a.subjectExamSelection[b],function(c,e){d.push({exam_type_id:c,grade_weight:void 0!==a.gradeWeight[b+"-"+c]?a.gradeWeight[b+"-"+c].grade_weight:0})}),e.subjects.push({subject_id:b,exams:d})}),d.addClass(e,j,k))}};var j=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Class was updated.":"Class was added.";b.$emit("classAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},k=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.deleteClass=function(){var c=e.confirm("Please Confirm","Are you sure you want to mark this class as deleted? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,class_id:a.theClass.class_id,status:"f"};d.setClassStatus(e,j,k)})},a.activateClass=function(){var c=e.confirm("Please Confirm","Are you sure you want to re-activate this class? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,class_id:a.theClass.class_id,status:"t"};d.setClassStatus(e,j,k)})},a.addClassCat=function(){var a=e.create("addClassCategory.html","addClassCategoryCtrl",{},{size:"sm",backdrop:"static"});a.result.then(function(a){void 0===b.classCats&&(b.classCats=[]),b.classCats.push(a)},function(){})},a.addSubject=function(){var b=window.location.host,c=e.create("http://"+b+"/app/school/subjectForm.html","subjectFormCtrl",{class_cat_id:a.theClass.class_cat_id},{size:"md",backdrop:"static"});c.result.then(function(b){g(a.theClass.class_cat_id)},function(){})},a.addExamType=function(){var b={class_cat_id:a.theClass.class_cat_id},c=e.create("addExamType.html","addExamTypeCtrl",b,{size:"sm",backdrop:"static"});c.result.then(function(b){a.examTypes.push(b)},function(){})},a.toggleSubjects=function(b){var c=a.subjectSelection.indexOf(b);c>-1?(a.subjectSelection.splice(c,1),a.subjectExamSelection[b]=void 0):(a.subjectSelection.push(b),a.subjectExamSelection[b]=[])},a.toggleSubjectExam=function(b,c){void 0===a.subjectExamSelection[b]&&(a.subjectExamSelection[b]=[]);var d=a.subjectExamSelection[b].indexOf(c);d>-1?a.subjectExamSelection[b].splice(d,1):a.subjectExamSelection[b].push(c)},a.$watch("subject.apply_to_all",function(b,c){b!=c&&(b?angular.forEach(a.subjects,function(b,c){a.subjectSelection.push(b.subject_id),a.subjectExamSelection[b.subject_id]=[]}):angular.forEach(a.subjects,function(b,c){a.subjectSelection=[],a.subjectExamSelection[b.subject_id]=void 0}))}),a.toggleAllExams=function(b,c){var d=a.apply_to_all_subjects[c]===!0;d?angular.forEach(a.subjects,function(c,d){void 0===a.subjectExamSelection[c.subject_id]&&(a.subjectExamSelection[c.subject_id]=[]),a.subjectExamSelection[c.subject_id].push(b)}):angular.forEach(a.subjects,function(c,d){var e=a.subjectExamSelection[c.subject_id].indexOf(b);a.subjectExamSelection[c.subject_id].splice(e,1)})}}]).controller("addExamTypeCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.examType={},a.examType.class_cat_id=e.class_cat_id,"TEACHER"==b.currentUser.user_type?d.getClassCats(b.currentUser.emp_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.classCats=c.data)},g):a.classCats=b.classCats,a.cancel=function(){c.dismiss("Canceled")},a.save=function(){a.examType.user_id=b.currentUser.user_id,d.addExamType(a.examType,f,g)};var f=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(e.data):(a.error=!0,a.errMsg=e.data)},g=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()}}]).run(["$templateCache",function(a){a.put("addExamType.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Add Exam Type</h4></div><div class="modal-body cleafix"><ng-form name="catDialog" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- exam type --><div class="form-group" ng-class="{ \'has-error\' : catDialog.exam_type.$invalid && (catDialog.exam_type.$touched || catDialog.$submitted) }"><label for="exam_type" class="col-sm-3 control-label">Exam Type</label><div class="col-sm-9"><input type="text" name="name" ng-model="examType.exam_type" class="form-control"  ><p ng-show="catDialog.exam_type.$invalid && (catDialog.exam_type.$touched || catDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Exan Type is required.</p></div></div><!-- class category --><div class="form-group"><label for="class_cat" class="col-sm-3 control-label">Class Category</label><div class="col-sm-9"><select name="class_cat" class="form-control" ng-options="cat.class_cat_id as cat.class_cat_name for cat in classCats"  ng-model="examType.class_cat_id" required><option value="">--select class category--</option></select></div></div></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="save()">Save</button></div>')}]),angular.module("eduwebApp").controller("classesCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.filters={},a.alert={};var g=function(){"TEACHER"==b.currentUser.user_type&&c.getClassCats(b.currentUser.emp_id,function(a){var c=angular.fromJson(a);"success"==c.response&&(b.classCats=c.data)},j),h("")};d(g,1);var h=function(e){if(void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),"TEACHER"==b.currentUser.user_type)c.getTeacherClasses(b.currentUser.emp_id,function(c,e){var f=angular.fromJson(c);"success"==f.response?(a.classes=f.nodata?[]:f.data,b.allClasses=a.classes,d(i,10)):(a.error=!0,a.errMsg=f.data)},j);else{var f=""!=e?e+"/true":"";c.getClasses(f,function(c,e){var f=angular.fromJson(c);"success"==f.response?(a.classes=f.nodata?[]:f.data,b.allClasses=a.classes,d(i,10)):(a.error=!0,a.errMsg=f.data)},j)}};a.loadFilter=function(){a.loading=!0,h(a.filters.class_cat_id)};var i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,filter:!0,order:[[1,"asc"],[2,"asc"]],info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No classes found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+45)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addClass=function(){a.openModal("school","classForm","lg")},a.viewClass=function(b){a.openModal("school","classForm","lg",b)},a.exportItems=function(){b.wipNotice()},a.$on("refreshClasses",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h(a.filters.class_cat_id||"")},a.$on("$destroy",function(){a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy()),b.isModal=!1})}]),angular.module("eduwebApp").controller("datesCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.filters={},a.alert={};var g=function(){a.years=[];for(var c=moment().format("YYYY"),d=void 0!==b.currentUser.settings["Initial Year"]?b.currentUser.settings["Initial Year"]:"2014",e=d;c>=e;e++)a.years.push(e);a.filters.year=c,h(c)};d(g,1);var h=function(b){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),c.getTerms(b,function(b,c,e){var f=angular.fromJson(b);"success"==f.response?(a.dates=f.nodata?[]:f.data,d(i,10)):(a.error=!0,a.errMsg=f.data)},j)};a.loadFilter=function(){a.loading=!0,h(a.filters.year)};var i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,filter:!0,order:[2,"asc"],info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No dates found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+45)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addDate=function(){a.openModal("school","datesForm","md")},a.viewDate=function(b){a.openModal("school","datesForm","md",b)},a.exportItems=function(){b.wipNotice()},a.$on("refreshDates",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h(a.filters.year)},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("datesFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.edit=void 0!==f,a.date=void 0!==f?f:{},a.initializeController=function(){if(a.edit)a.start_date=a.date.start_date,a.end_date=a.date.end_date;else{var b=moment().format("YYYY-MM-DD");a.start_date=b,a.end_date=b}},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.save=function(b){if(!b.$invalid){var c=a.date;c.start_date=moment(a.start_date).format("YYYY-MM-DD"),c.end_date=moment(a.end_date).format("YYYY-MM-DD"),a.edit?d.updateTerm(c,g,h):d.addTerm(c,g,h)}};var g=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Term was updated.":"Term was added.";b.$emit("termAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("departmentFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.edit=void 0!==f,a.department=void 0!==f?f:{},a.initializeController=function(){a.categories=b.empCats},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.save=function(c){if(!c.$invalid){var e=a.department;e.user_id=b.currentUser.user_id,a.edit?d.updateDept(e,g,h):d.addDept(e,g,h)}};var g=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Department was updated.":"Department was added.";b.$emit("deptAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.deleteDept=function(){var c=e.confirm("Please Confirm","Are you sure you want to mark this department as deleted? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,dept_id:a.department.dept_id,status:"f"};d.setDeptStatus(e,g,h)})},a.activateDept=function(){var c=e.confirm("Please Confirm","Are you sure you want to re-activate this department? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,dept_id:a.department.dept_id,status:"t"};d.setDeptStatus(e,g,h)})},a.addCat=function(){var c=e.create("addCategory.html","addCategoryCtrl",{},{size:"sm",backdrop:"static"});c.result.then(function(c){a.categories.push(c),d.getSettings({},function(a){var c=angular.fromJson(a);if("success"==c.response){var d=c.data.reduce(function(a,b){return a[b.name]=b.value,a},{});b.$emit("setSettings",d)}},h)},function(){})}}]).controller("addCategoryCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.category={},a.cancel=function(){c.dismiss("Canceled")},a.save=function(){var b={name:"Department Categories",value:a.category.name,append:!0};d.updateSetting(b,f,g)};var f=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(a.category.name):(a.error=!0,a.errMsg=e.data)},g=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()}}]).run(["$templateCache",function(a){a.put("addCategory.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Add Category</h4></div><div class="modal-body cleafix"><ng-form name="catDialog" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- name --><div class="form-group" ng-class="{ \'has-error\' : catDialog.name.$invalid && (catDialog.name.$touched || catDialog.$submitted) }"><label for="name" class="col-sm-3 control-label">Category Name</label><div class="col-sm-9"><input type="text" name="name" ng-model="category.name" class="form-control"  ><p ng-show="catDialog.name.$invalid && (catDialog.name.$touched || catDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Category Name is required.</p></div></div></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="save()">Save</button></div>')}]),angular.module("eduwebApp").controller("departmentsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.alert={};var g=function(){h()};d(g,1);var h=function(){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),c.getDepts({},function(c,e,f){var g=angular.fromJson(c);"success"==g.response?(a.departments=g.nodata?[]:g.data,b.allDepts=a.departments,d(i,10)):(a.error=!0,a.errMsg=g.data)},j)},i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,filter:!0,order:[1,"asc"],info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No departments found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",0)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addDept=function(){a.openModal("school","departmentForm","md")},a.viewDepartment=function(b){a.openModal("school","departmentForm","md",b)},a.exportItems=function(){b.wipNotice()},a.$on("refreshDepartments",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h()},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("gradingCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.alert={};var g=function(){h()};d(g,1);var h=function(){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),c.getGrading({},function(b,c,e){var f=angular.fromJson(b);"success"==f.response?(a.grades=f.nodata?[]:f.data,a.grades=a.grades.map(function(a){return a.mark_range=a.min_mark+"-"+a.max_mark,a}),d(i,10)):(a.error=!0,a.errMsg=f.data)},j)},i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No grading entries found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:13;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",0)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addGrading=function(){a.openModal("school","gradingForm","sm")},a.viewGrading=function(b){a.openModal("school","gradingForm","sm",b)},a.$on("refreshGrades",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h()},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("gradingFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.edit=void 0!==f,a.grading=void 0!==f?f:{},a.initializeController=function(){},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.save=function(b){if(!b.$invalid){var c=a.grading;a.edit?d.updateGrading(c,g,h):d.addGrading(c,g,h)}};var g=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Grading was updated.":"Grading was added.";b.$emit("gradingAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]),angular.module("eduwebApp").controller("schoolSettingsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter","FileUploader","dialogs",function(a,b,c,d,e,f,g,h){a.alert={};var i=function(){a.schoolTypes=["Private School","Public School"],a.curriculums=["8-4-4"],a.currencies=["Ksh"],a.schoolLevels=["Primary","Secondary"],void 0===b.currentUser.settings["School Name"]&&(a.initialSetup=!0),k()};d(i,1);var j=function(){c.getSettings({},function(a){var c=angular.fromJson(a);if("success"==c.response){var d=c.data.reduce(function(a,b){return a[b.name]=b.value,a},{});b.$emit("setSettings",d),k()}},m)},k=function(){a.settings={"Address 1":angular.copy(b.currentUser.settings["Address 1"]),"Address 2":angular.copy(b.currentUser.settings["Address 2"]),Country:angular.copy(b.currentUser.settings.Country),Curriculum:angular.copy(b.currentUser.settings.Curriculum),"Email Address":angular.copy(b.currentUser.settings["Email Address"]),"Email From":angular.copy(b.currentUser.settings["Email From"]),"Phone Number":angular.copy(b.currentUser.settings["Phone Number"]),"School Name":angular.copy(b.currentUser.settings["School Name"]),"School Type":angular.copy(b.currentUser.settings["School Type"]),"School Level":angular.copy(b.currentUser.settings["School Level"]),logo:angular.copy(b.currentUser.settings.logo),Currency:angular.copy(b.currentUser.settings.Currency)}};a.$watch("uploader.queue[0]",function(b,c){void 0!==b&&a.schoolForm.$setDirty()}),a.save=function(b){if(a.error=!1,a.errMsg="",!b.$invalid){void 0!==n.queue[0]&&(n.queue[0].file.name=n.queue[0].file.name,n.uploadAll());var d=[];angular.forEach(a.settings,function(a,b){void 0!==n.queue[0]&&"logo"==b?d.push({name:"logo",value:"assets/"+n.queue[0].file.name,append:!1}):d.push({name:b,value:a,append:!1})});var e={settings:d};a.saving=!0,c.updateSettings(e,l,m)}};var l=function(b,c){var d=angular.fromJson(b);"success"==d.response?(a.initialSetup=!1,j(),a.schoolForm.$setPristine(),a.saving=!1):(a.error=!0,a.errMsg=d.data)};a.addEmpCat=function(){var a=h.create("addEmpCategory.html","addEmpCategoryCtrl",{},{size:"sm",backdrop:"static"});a.result.then(function(a){b.empCats=void 0,b.getEmpCats()},function(){})},a.editEmpCat=function(a){var c=h.create("addEmpCategory.html","addEmpCategoryCtrl",{item:a},{size:"sm",backdrop:"static"});c.result.then(function(a){b.empCats=void 0,b.getEmpCats()},function(){})},a.removeEmpCat=function(d){var e=h.confirm("Delete Employee Category","You are deleting employee category <strong>"+d.emp_cat_name+"</strong>, do you wish to continue?",{size:"sm"});e.result.then(function(e){var f={user_id:b.currentUser.user_id,emp_cat_id:d.emp_cat_id,status:"f"};c.setEmployeeCatStatus(f,function(c,d){var e=angular.fromJson(c);"success"==e.response?(b.empCats=void 0,b.getEmpCats()):(a.error=!0,a.errMsg=e.data)},m)})},a.addClassCat=function(){var a=h.create("addClassCategory.html","addClassCategoryCtrl",{},{size:"sm",backdrop:"static"});a.result.then(function(a){b.classCats=void 0,b.getClassCats()},function(){})},a.editClassCat=function(a){var c=h.create("addClassCategory.html","addClassCategoryCtrl",{item:a},{size:"sm",backdrop:"static"});c.result.then(function(a){b.classCats=void 0,b.getClassCats()},function(){})},a.removeClassCat=function(d){var e=h.confirm("Delete Class Category","You are deleting class category <strong>"+d.class_cat_name+"</strong>, do you wish to continue?",{size:"sm"});e.result.then(function(e){var f={user_id:b.currentUser.user_id,class_cat_id:d.class_cat_id,status:"f"};c.setClassCatStatus(f,function(c,d){var e=angular.fromJson(c);"success"==e.response?(b.classCats=void 0,b.getClassCats()):(a.error=!0,a.errMsg=e.data)},m)})};var m=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data},n=a.uploader=new g({url:"upload.php",formData:[{dir:""}]});a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]).controller("addEmpCategoryCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.edit=void 0!==f.item,a.empCat=f.item||{},a.cancel=function(){c.dismiss("Canceled")},a.save=function(){if(a.edit){var c=e.confirm("Update Employee Category","Are you sure you want to update this employee category? It will also update all employees that are associated with this category.",{size:"sm"});c.result.then(function(c){var e={emp_cat_id:a.empCat.emp_cat_id,emp_cat_name:a.empCat.emp_cat_name,user_id:b.currentUser.user_id};d.updateEmployeeCat(e,g,h)})}else{var f={emp_cat_name:a.empCat.emp_cat_name,user_id:b.currentUser.user_id};d.addEmployeeCat(f,g,h)}};var g=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(e.data):(a.error=!0,a.errMsg=e.data)},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()}}]).run(["$templateCache",function(a){a.put("addEmpCategory.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> {{ (edit ? \'Update\' : \'Add\') }} Employee Category</h4></div><div class="modal-body cleafix"><ng-form name="catDialog" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- emp_cat_name --><div class="form-group" ng-class="{ \'has-error\' : catDialog.emp_cat_name.$invalid && (catDialog.emp_cat_name.$touched || catDialog.$submitted) }"><label for="emp_cat_name" class="col-sm-3 control-label">Employee Category Name</label><div class="col-sm-9"><input type="text" name="emp_cat_name" ng-model="empCat.emp_cat_name" class="form-control" required ><p ng-show="catDialog.emp_cat_name.$invalid && (catDialog.emp_cat_name.$touched || catDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Employee Category Name is required.</p></div></div></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="save()">{{ (edit ? \'Update\' : \'Save\') }}</button></div>')}]),angular.module("eduwebApp").controller("subjectFormCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.subject=void 0!==f?f:{},a.edit=void 0!==f&&void 0!==f.subject_id,
a.initializeController=function(){d.getAllTeachers(!0,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.teachers=c.data)},h)},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.save=function(c){if(!c.$invalid){var e=a.subject;e.user_id=b.currentUser.user_id,a.edit?d.updateSubject(e,g,h):d.addSubject(e,g,h)}};var g=function(d,e,f){var g=angular.fromJson(d);if("success"==g.response){c.close();var h=a.edit?"Subject was updated.":"Subject was added.";b.$emit("subjectAdded",{msg:h,clear:!0})}else a.error=!0,a.errMsg=g.data},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.deleteSubject=function(){var c=e.confirm("Please Confirm","Are you sure you want to mark this subject as deleted? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,subject_id:a.subject.subject_id,status:"f"};d.setSubjectStatus(e,g,h)})},a.activateSubject=function(){var c=e.confirm("Please Confirm","Are you sure you want to re-activate this subject? ",{size:"sm"});c.result.then(function(c){var e={user_id:b.currentUser.user_id,subject_id:a.subject.subject_id,status:"t"};d.setSubjectStatus(e,g,h)})},a.addClassCat=function(){var a=e.create("addClassCategory.html","addClassCategoryCtrl",{},{size:"sm",backdrop:"static"});a.result.then(function(a){b.classCats.push(a)},function(){})}}]).controller("addClassCategoryCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","data",function(a,b,c,d,e,f){a.edit=void 0!==f.item,a.classCat=f.item||{},a.cancel=function(){c.dismiss("Canceled")},a.save=function(){if(a.edit){var c=e.confirm("Update Class Category","Are you sure you want to update this class category? It will also update all students that are associated with this category.",{size:"sm"});c.result.then(function(c){var e={class_cat_id:a.classCat.class_cat_id,class_cat_name:a.classCat.class_cat_name,user_id:b.currentUser.user_id};d.updateClassCat(e,g,h)})}else{var f={class_cat_name:a.classCat.class_cat_name,user_id:b.currentUser.user_id};d.addClassCat(f,g,h)}};var g=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(e.data):(a.error=!0,a.errMsg=e.data)},h=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()}}]).run(["$templateCache",function(a){a.put("addClassCategory.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> {{ (edit ? \'Update\' : \'Add\') }} Class Category</h4></div><div class="modal-body cleafix"><ng-form name="catDialog" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- class_cat_name --><div class="form-group" ng-class="{ \'has-error\' : catDialog.class_cat_name.$invalid && (catDialog.class_cat_name.$touched || catDialog.$submitted) }"><label for="class_cat_name" class="col-sm-3 control-label">Class Category Name</label><div class="col-sm-9"><input type="text" name="class_cat_name" ng-model="classCat.class_cat_name" class="form-control" required ><p ng-show="catDialog.class_cat_name.$invalid && (catDialog.class_cat_name.$touched || catDialog.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Class Category Name is required.</p></div></div></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="save()">{{ (edit ? \'Update\' : \'Save\') }}</button></div>')}]),angular.module("eduwebApp").controller("subjectsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$filter",function(a,b,c,d,e,f){a.filters={},a.alert={};var g=function(){h("")};d(g,1);var h=function(b){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),c.getSubjects(b,function(b,c,e){var f=angular.fromJson(b);"success"==f.response?(a.subjects=f.nodata?[]:f.data,d(i,10)):(a.error=!0,a.errMsg=f.data)},j)};a.loadFilter=function(){a.loading=!0,h(a.filters.class_cat_id)};var i=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,filter:!0,order:[[1,"asc"],[2,"asc"]],info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No subjects found."}});var d=$(".navbar-fixed-top").height(),f=$("#body-content .content-fixed-header").height(),g=b.isSmallScreen?22:41;if(new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+f+g}),!b.isSmallScreen){var h=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",h+45)}e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.addSubject=function(){a.openModal("school","subjectForm","md")},a.viewSubject=function(b){a.openModal("school","subjectForm","md",b)},a.exportItems=function(){b.wipNotice()},a.$on("refreshSubjects",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h(a.filters.class_cat_id||"")},a.$on("$destroy",function(){a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy()),b.isModal=!1})}]),angular.module("eduwebApp").controller("addEmployeeCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","FileUploader","data","$parse",function(a,b,c,d,e,f,g,h){a.employee={};var i=moment().format("YYYY-MM-DD HH:MM");a.employee.joined_date=i,a.employee.country="Kenya",a.employee.status="true",a.initializeController=function(){a.departments=b.allDepts},a.initializeController(),a.cancel=function(){c.dismiss("canceled")},a.$watch("employee.emp_cat",function(c,d){c!=d&&(void 0===c||null===c||""==c?a.departments=b.allDepts:(a.departments=b.allDepts.reduce(function(a,b){return b.category==c.emp_cat_name&&a.push(b),a},[]),a.employee.emp_cat_id=c.emp_cat_id))}),a.save=function(c){if(c.$invalid)a.formError=!0,a.errMsg="There were errors found in the form.";else{void 0!==l.queue[0]&&(a.employee.emp_image=l.queue[0].file.name);var e=angular.copy(a.employee);e.user_id=b.currentUser.user_id,e.active="true"==a.employee.status?"t":"f",d.addEmployee(e,j,k)}};var j=function(d,e){var f=angular.fromJson(d);"success"==f.response?(l.uploadAll(),c.close(),b.$emit("employeeAdded",{msg:"Employee was created.",clear:!0})):(a.formError=!0,a.errMsg=f.data)},k=function(){var b=angular.fromJson(response);a.formError=!0,a.errMsg=b.data},l=a.uploader=new f({url:"upload.php",formData:[{dir:"employees"}]})}]),angular.module("eduwebApp").controller("listStaffCtrl",["$scope","$rootScope","apiService","$timeout","$window","$state",function(a,b,c,d,e,f){var g=!0;a.employees=[],a.filters={},a.filters.status="true",a.filters.emp_cat_id=""!==f.params.category?f.params.category:null,a.filterEmpCat=""!==f.params.category,a.filters.dept_id=""!==f.params.dept?f.params.dept:null,a.filterDept=""!==f.params.dept,a.alert={};var h=function(){c.getAllEmployees(!0,function(b){var c=angular.fromJson(b);"success"==c.response?(void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),a.allEmployees=void 0!==c.nondata?[]:c.data,a.employees=a.allEmployees,void 0!==a.currentFilters||a.filterEmpCat||a.filterDept?m():d(j,10)):d(j,10)},function(){})},i=function(){a.departments=b.allDepts,h()};d(i,1e3),a.$watch("filters.emp_cat",function(c,e){e!=c&&(void 0===c||null===c||""==c?a.departments=b.allDepts:(a.departments=b.allDepts.reduce(function(a,b){return b.category==c.emp_cat_name&&a.push(b),a},[]),a.filters.emp_cat_id=c.emp_cat_id,d(k,10)))});var j=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[1,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_"}});var d=$(".navbar-fixed-top").height(),e=$("#body-content .content-fixed-header").height(),f=b.isSmallScreen?22:13;new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+e+f}),k(),g&&l()},k=function(){if(!b.isSmallScreen){var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a+45)}},l=function(){g=!1,e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.filter=function(){a.currentFilters=angular.copy(a.filters),m()};var m=function(){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy());var b=a.allEmployees;void 0!==a.filters.emp_cat_id&&null!==a.filters.emp_cat_id&&""!=a.filters.emp_cat_id&&(b=b.reduce(function(b,c){return c.emp_cat_id.toString()==a.filters.emp_cat_id.toString()&&b.push(c),b},[])),void 0!==a.filters.dept_id&&null!==a.filters.dept_id&&""!=a.filters.dept_id&&(b=b.reduce(function(b,c){return c.dept_id.toString()==a.filters.dept_id.toString()&&b.push(c),b},[])),a.employees=b,d(j,1)};a.addEmployee=function(){a.openModal("staff","addEmployee","lg")},a.viewEmployee=function(b){a.openModal("staff","viewEmployee","lg",b)},a.exportData=function(){b.wipNotice()},a.$on("refreshStaff",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,h()},a.$on("$destroy",function(){a.dataGrid&&a.dataGrid.destroy(),b.isModal=!1})}]),angular.module("eduwebApp").controller("viewEmployeeCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","FileUploader","data",function(a,b,c,d,e,f,g){b.modalLoading=!1,a.tabs=["Personal Info","Employee Info"],a.currentTab=a.tabs[0],a.hasChanges=!1;var h;a.filters={},a.edit=!!b.permissions.staff.edit,a.initializeController=function(){d.getEmployeeDetails(g.emp_id,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.employee=d.data,a.employee.joined_date={startDate:a.employee.joined_date},a.employee.emp_cat=b.empCats.filter(function(b){return b.emp_cat_id==a.employee.emp_cat_id?b:void 0})[0])})},a.initializeController(),a.getTabContent=function(b){if(a.empForm.$pristine)i(b);else{var c=e.confirm("Changes Where Made","You have made changes to the data on this page. Did you want to save these changes?",{size:"sm"});c.result.then(function(c){a.save(a.empForm,b)},function(c){a.employee=angular.copy(h),a.empForm.$setPristine(),i(b)})}};var i=function(b){a.currentTab=b};a.cancel=function(){c.dismiss("canceled")},a.$watch("employee.emp_cat",function(c,d){c!=d&&(void 0===c||null===c||""==c?a.departments=b.allDepts:(a.departments=b.allDepts.reduce(function(a,b){return b.category==c.emp_cat_name&&a.push(b),a},[]),a.employee.emp_cat_id=c.emp_cat_id))}),a.$watch("uploader.queue[0]",function(b,c){void 0!==b&&a.empForm.$setDirty()}),a.save=function(c,e){if(!c.$invalid){if("Personal Info"==a.currentTab){void 0!==l.queue[0]&&(l.queue[0].file.name=a.employee.emp_id+"_"+l.queue[0].file.name,l.uploadAll());var f={emp_id:a.employee.emp_id,user_id:b.currentUser.user_id,personal:{first_name:a.employee.first_name,middle_name:a.employee.middle_name,last_name:a.employee.last_name,initials:a.employee.initials,id_number:a.employee.id_number,country:a.employee.country,gender:a.employee.gender,dob:a.employee.dob,emp_image:void 0!==l.queue[0]?l.queue[0].file.name:null,active:a.employee.active?"t":"f",telephone:a.employee.telephone,email:a.employee.email,next_of_kin_name:a.employee.next_of_kin_name,next_of_kin_telephone:a.employee.next_of_kin_telephone,next_of_kin_email:a.employee.next_of_kin_email}}}else if("Employee Info"==a.currentTab)var f={emp_id:a.employee.emp_id,user_id:b.currentUser.user_id,employee:{emp_number:a.employee.emp_number,emp_cat_id:a.employee.emp_cat_id,dept_id:a.employee.dept_id,job_title:a.employee.job_title,joined_date:null!==a.employee.joined_date.startDate?moment(a.employee.joined_date.startDate).format("YYYY-MM-DD"):null,qualifications:a.employee.qualifications,experience:a.employee.experience,additional_info:a.employee.additional_info}};d.updateEmployee(f,j,k,{tab:e})}};var j=function(c,d,e){var f=angular.fromJson(c);"success"==f.response?(void 0!==l.queue[0]&&(a.employee.emp_image=l.queue[0].file.name),h=angular.copy(a.employee),a.empForm.$setPristine(),void 0!==e.tab&&i(e.tab),b.$emit("employeeAdded",{msg:"Employee was updated.",clear:!0})):(a.error=!0,a.errMsg=f.data)},k=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data},l=a.uploader=new f({url:"upload.php",formData:[{dir:"employees"}]})}]),angular.module("eduwebApp").controller("addStudentCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","FileUploader","data","$parse",function(a,b,c,d,e,f,g,h){a.tabs=["Student Details","Parents","Medical History","Fee Items"],a.formNames=["studentDetails","parentGuardians","medicalHistory","feeItems"],a.currentTab="Student Details",a.currentStep=0,a.firstStep=!0,a.forms={},a.student={};var i=moment().format("YYYY-MM-DD HH:MM");a.student.admission_date={startDate:i},a.student.student_category="Regular",a.student.nationality="Kenya",a.student.status="true",a.student.other_medical_conditions="false",a.student.hospitalized="false",a.student.current_medical_treatment="false",a.showSeparationAge=!1,a.feeItemSelection=[],a.optFeeItemSelection=[],a.conditionSelection=[],a.formError=!1;var j=["new_student","admission_number","current_class","last_name","first_name","dob","gender","emergency_name","emergency_relationship","emergency_telephone"],k=["father_last_name","father_first_name","father_id_number","father_telephone","father_email","mother_last_name","mother_first_name","mother_id_number","mother_telephone","mother_email"],l=["payment_method","installment_option"];a.submitted=!1,a.initializeController=function(){var c=b.currentUser.settings["Student Categories"];a.studentCats=c.split(",");var e=b.currentUser.settings["Payment Options"];a.paymentOptions=e.split(",");var f=b.currentUser.settings["Guardian Relationships"];a.relationships=f.split(",");var g=b.currentUser.settings["Marital Statuses"];a.maritalStatuses=g.split(",");var h=b.currentUser.settings.Titles;a.titles=h.split(",");var i=b.currentUser.settings["Medical Conditions"];i=i.split(","),a.medicalConditions=i.reduce(function(a,b){return a.push({medical_condition:b,age:"",comments:""}),a},[]),d.getFeeItems({},function(b){var c=angular.fromJson(b);"success"==c.response&&(a.feeItems=m(c.data.required_items),a.allFeeItems=a.feeItems,a.optFeeItems=m(c.data.optional_items),a.allOptFeeItems=a.optFeeItems)},function(){}),d.getTansportRoutes({},function(b){var c=angular.fromJson(b);"success"==c.response&&(a.transportRoutes=c.data)},function(){})},a.initializeController();var m=function(a){return a.map(function(a){if(null!==a.class_cats_restriction&&"{}"!=a.class_cats_restriction){var b=a.class_cats_restriction.slice(1,-1);a.class_cats_restriction=b.split(",")}return a.amount=void 0,a.payment_method=void 0,a})};a.getStep=function(a,b){b.$pristine?n(a,b):(b.$setDirty(),b.$setSubmitted(),b.$invalid||n(a,b))};var n=function(b,c){a.currentStep="next"==b?a.currentStep+1:a.currentStep-1,a.getTabContent(a.tabs[a.currentStep],c)};a.getTabContent=function(b,c){a.forms[a.currentTab]=angular.copy(c),a.submitted&&p(),a.currentTab=b,a.currentStep=a.tabs.indexOf(b),a.currentForm=a.formNames[a.currentStep],a.lastStep=!1,a.firstStep=!1,a.currentTab==a.tabs[0]?a.firstStep=!0:a.currentTab==a.tabs[a.tabs.length-1]&&(a.lastStep=!0)},a.cancel=function(){c.dismiss("canceled")},a.$watch("student.payment_method",function(a,b){}),a.$watch("student.new_student",function(b,c){b!=c&&(a.feeItems=o(a.allFeeItems))}),a.$watch("student.current_class",function(b,c){b!=c&&(a.feeItems=o(a.allFeeItems),a.optFeeItems=o(a.allOptFeeItems))}),a.$watch("student.transport_route",function(b,c){b!=c&&angular.forEach(a.optFeeItemSelection,function(a,c){"Transport"==a.fee_item&&(a.amount=b.amount)})});var o=function(b){var c=[];return c="true"==a.student.new_student?b:b.filter(function(a){return a.new_student_only?void 0:a}),void 0!==a.student.current_class&&(c=c.filter(function(b){return null===b.class_cats_restriction||"{}"==b.class_cats_restriction?b:b.class_cats_restriction.indexOf(a.student.current_class.class_cat_id.toString())>-1?b:void 0})),c};a.toggleFeeItem=function(b,c){var d="optional"==c?a.optFeeItemSelection:a.feeItemSelection,e=d.indexOf(b);e>-1?(d.splice(e,1),b.amount=void 0,b.payment_method=void 0,"Transport"==b.fee_item&&(a.showTransport=!1)):(b.amount=b.default_amount,b.payment_method=a.student.payment_method,d.push(b),"Transport"==b.fee_item&&(a.showTransport=!0))},a.toggleMedicalCondition=function(b){var c=a.conditionSelection.indexOf(b);c>-1?a.conditionSelection.splice(c,1):a.conditionSelection.push(b)},a.hasErrors=function(b){switch(b){case"Student Details":return a.detailsErrors>0;case"Parents":return a.guardianErrors>0;case"Medical History":return a.medicalErrors>0;case"Fee Items":return a.feeErrors>0}},a.getErrorCount=function(b){switch(b){case"Student Details":return a.detailsErrors;case"Parents":return a.guardianErrors;case"Medical History":return a.medicalErrors;case"Fee Items":return a.feeErrors}},a.save=function(c){if(a.forms[a.currentTab]=angular.copy(c),a.submitted=!0,c.$invalid)a.formError=!0,a.errMsg="There were errors found in the form.",p();else{void 0!==s.queue[0]&&(a.student.student_image=s.queue[0].file.name),a.student.has_medical_conditions=!!(a.conditionSelection.length>0||a.student.other_medical_conditions);var e=angular.copy(a.student);e.admission_date=a.student.admission_date.startDate,e.current_class=a.student.current_class.class_id,e.new_student=a.student.new_student?"t":"f",e.medicalConditions=a.conditionSelection,e.feeItems=a.feeItemSelection,e.optFeeItems=a.optFeeItemSelection,e.user_id=b.currentUser.user_id,d.postStudent(e,q,r)}};var p=function(){a.detailsErrors=0,a.guardianErrors=0,a.feeErrors=0,a.formErrorList=[],angular.forEach(a.forms,function(b,c){for(var d in b.$error)for(var e=0;e<b.$error[d].length;e++)a.formErrorList.push(b.$error[d][e].$name+" is required."),j.indexOf(b.$error[d][e].$name)>-1?a.detailsErrors++:k.indexOf(b.$error[d][e].$name)>-1?a.guardianErrors++:l.indexOf(b.$error[d][e].$name)>-1&&a.feeErrors++})},q=function(d,e){var f=angular.fromJson(d);"success"==f.response?(s.uploadAll(),c.close(),b.$emit("studentAdded",{msg:"Student was created.",clear:!0})):(a.formError=!0,a.errMsg=f.data)},r=function(){var b=angular.fromJson(response);a.formError=!0,a.errMsg=b.data},s=a.uploader=new f({url:"upload.php",formData:[{dir:"students"}]})}]),angular.module("eduwebApp").controller("listStudentsCtrl",["$scope","$rootScope","apiService","$timeout","$window","$state",function(a,b,c,d,e,f){var g=!0;a.filters={},a.filters.status="true",a.filters.class_cat_id=""!==f.params.filter?f.params.filter:null,a.filterClassCat=""!==f.params.filter,a.students=[],a.filterShowing=!1,a.toolsShowing=!1;var h=!0,i=!1;b.modalLoading=!1,a.alert={};var j=function(){"TEACHER"==b.currentUser.user_type?c.getClassCats(b.currentUser.emp_id,function(d){var e=angular.fromJson(d);"success"==e.response&&(b.classCats=e.data,void 0===b.allClasses?c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses,k("true",!1),1==b.classCats.length&&(a.filters.class_cat_id=b.classCats[0].class_cat_id))},m):(a.classes=b.allClasses,k("true",!1),1==b.classCats.length&&(a.filters.class_cat_id=b.classCats[0].class_cat_id)))},m):void 0===b.allClasses?c.getAllClasses({},function(c){var d=angular.fromJson(c);"success"==d.response&&(b.allClasses=d.data,a.classes=b.allClasses,k("true",!1))},m):(a.classes=b.allClasses,k("true",!1))};d(j,1);var k=function(a,d){if("TEACHER"==b.currentUser.user_type){var e=b.currentUser.emp_id+"/"+a;c.getTeacherStudents(e,l,m,{filtering:d})}else c.getAllStudents(a,l,m,{filtering:d})},l=function(c,e,f){var g=angular.fromJson(c);if("success"==g.response){if(void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear()),g.nodata)var h=[];else var h=b.formatStudentData(g.data);f.filtering?(a.formerStudents=h,q()):(a.allStudents=h,a.students=h,a.filterClassCat&&q(),d(n,10))}else a.error=!0,a.errMsg=g.data},m=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data},n=function(){var c=$("#resultsTable");a.dataGrid=c.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:[1,"asc"],filter:!0,info:!1,sorting:[],initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{search:"Search Results<br>",searchPlaceholder:"Filter",lengthMenu:"Display _MENU_",emptyTable:"No students found."}});var d=$(".navbar-fixed-top").height(),e=$("#body-content .content-fixed-header").height(),f=b.isSmallScreen?22:13;new $.fn.dataTable.FixedHeader(a.dataGrid,{header:!0,headerOffset:d+e+f}),o(),g&&p()},o=function(){if(!b.isSmallScreen){var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a+45)}},p=function(){g=!1,e.addEventListener("resize",function(){if(b.isSmallScreen=window.innerWidth<768,b.isSmallScreen)$("#resultsTable_filter").css("left",0);else{var a=$(".dataFilterForm form").width();$("#resultsTable_filter").css("left",a-30)}},!1)};a.$watch("filters.class_cat_id",function(c,e){e!=c&&(void 0===c||""==c?a.classes=b.allClasses:(a.classes=b.allClasses.reduce(function(a,b){return b.class_cat_id==c&&a.push(b),a},[]),d(o,10)))}),a.toggleFilter=function(){a.filterShowing=!a.filterShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.toggleTools=function(){a.toolsShowing=!a.toolsShowing,a.filterShowing||a.toolsShowing?$("#resultsTable_filter").hide():d(function(){$("#resultsTable_filter").show()},500)},a.loadFilter=function(){a.loading=!0,i=!0,"false"==a.filters.status&&void 0===a.formerStudents?k("false",!0):q(),h=a.filters.status};var q=function(){void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy());var b="false"==a.filters.status?a.formerStudents:a.allStudents;void 0!==a.filters.class_cat_id&&null!==a.filters.class_cat_id&&""!==a.filters.class_cat_id&&(b=b.reduce(function(b,c){return c.class_cat_id.toString()==a.filters.class_cat_id.toString()&&b.push(c),b},[])),void 0!==a.filters.class_id&&null!==a.filters.class_id&&""!==a.filters.class_id&&(b=b.reduce(function(b,c){return c.class_id.toString()==a.filters.class_id.toString()&&b.push(c),b},[])),a.students=b,d(n,1)};a.addStudent=function(){a.openModal("students","addStudent","lg")},a.viewStudent=function(b){a.openModal("students","viewStudent","lg",b)},a.importStudents=function(){b.wipNotice()},a.exportData=function(){b.wipNotice()},a.$on("refreshStudents",function(c,e){a.loading=!0,b.loading=!0,void 0!==e&&(a.updated=!0,a.notificationMsg=e.msg),a.refresh(),d(function(){a.alert.expired=!0},2e3),d(function(){a.updated=!1,a.notificationMsg="",a.alert.expired=!1},3e3)}),a.refresh=function(){a.loading=!0,b.loading=!0,void 0!==a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.clear(),a.dataGrid.destroy()),k(h,i)},a.$on("$destroy",function(){a.dataGrid&&($(".fixedHeader-floating").remove(),a.dataGrid.destroy()),b.isModal=!1})}]),angular.module("eduwebApp").controller("viewStudentCtrl",["$scope","$rootScope","$uibModalInstance","apiService","dialogs","FileUploader","data",function(a,b,c,d,e,f,g){b.modalLoading=!1,a.tabs="TEACHER"==b.currentUser.user_type?["Details","Family","Medical History","Exams","Report Cards","News"]:["Details","Family","Medical History","Fees","Exams","Report Cards","News"],a.feeTabs=["Fee Summary","Invoices","Payments Received","Fee Items"],a.currentTab=a.tabs[0],a.currentFeeTab=a.feeTabs[0],a.hasChanges=!1,a.currency=b.currentUser.settings.Currency;var h;a.filters={},a.edit=!!b.permissions.students.edit,a.feeItemSelection=[],a.optFeeItemSelection=[],a.conditionSelection=[],a.student={},a.student.admission_date={startDate:null},a.initializeController=function(){d.getStudentDetails(g.student_id,function(c){var d=angular.fromJson(c);if("success"==d.response){var e=b.formatStudentData([d.data]),f=b.allClasses.filter(function(a){return a.class_id==e[0].class_id?a:void 0});e[0].current_class=f[0],a.student=e[0],h=angular.copy(a.student),i()}});var c=b.currentUser.settings["Student Categories"];a.studentCats=c.split(",");var e=b.currentUser.settings["Payment Options"];a.paymentOptions=e.split(",");var f=b.currentUser.settings["Guardian Relationships"];a.relationships=f.split(",");var j=b.currentUser.settings["Marital Statuses"];a.maritalStatuses=j.split(",");var k=b.currentUser.settings.Titles;a.titles=k.split(",");var l=b.currentUser.settings["Medical Conditions"];l=l.split(","),a.medicalConditions=l.reduce(function(a,b){return a.push({medical_condition:b,age:"",comments:""}),a},[]),d.getTansportRoutes({},function(b){var c=angular.fromJson(b);"success"==c.response&&(a.transportRoutes=c.data)},function(){})},a.initializeController();var i=function(){d.getFeeItems({},function(b){var c=angular.fromJson(b);"success"==c.response&&(a.feeItems=s(c.data.required_items),a.allFeeItems=a.feeItems,a.feeItems=u(a.allFeeItems),a.feeItemSelection=t(a.feeItems),a.optFeeItems=s(c.data.optional_items),a.allOptFeeItems=a.optFeeItems,a.optFeeItems=u(a.allOptFeeItems),a.optFeeItemSelection=t(a.optFeeItems))},function(){})};a.getTabContent=function(b){if(a.studentForm.$pristine)j(b);else{var c=e.confirm("Changes Where Made","You have made changes to the data on this page. Did you want to save these changes?",{size:"sm"});c.result.then(function(c){a.save(a.studentForm,b)},function(c){a.student=angular.copy(h),a.studentForm.$setPristine(),j(b)})}};var j=function(c){if("Fees"==c)a.loading=!0,a.currentFeeTab="Fee Summary",d.getStudentBalance(a.student.student_id,m,y);else if("Exams"==c){if(a.loading=!0,a.filters["class"]=a.student.current_class,a.filters.class_cat_id=a.student.class_cat_id,a.filters.class_id=a.student.class_id,a.classes=b.allClasses.filter(function(b){return b.class_cat_id==a.filters.class_cat_id?b:void 0}),void 0===b.terms)d.getTerms(void 0,k,function(){});else{a.terms=b.terms;var e=a.terms.filter(function(a){return a.current_term?a:void 0})[0];a.filters.term_id=e.term_id,a.getExams()}void 0===b.examTypes?d.getExamTypes(void 0,function(c){var d=angular.fromJson(c);"success"==d.response&&(a.examTypes=d.data,b.examTypes=d.data)},function(){}):a.examTypes=b.examTypes}else if("Report Cards"==c){if(a.loading=!0,a.filters["class"]=a.student.current_class,a.filters.class_cat_id=a.student.class_cat_id,a.filters.class_id=a.student.class_id,a.classes=b.allClasses.filter(function(b){return b.class_cat_id==a.filters.class_cat_id?b:void 0}),void 0===b.terms)d.getTerms(void 0,k,function(){});else{a.terms=b.terms;var e=a.terms.filter(function(a){return a.current_term?a:void 0})[0];a.filters.term_id=e.term_id}a.getStudentReportCards()}a.currentTab=c},k=function(c,d){var e=angular.fromJson(c);if("success"==e.response){a.terms=e.data,b.terms=e.data;var f=a.terms.filter(function(a){return a.current_term?a:void 0})[0];a.filters.term_id=f.term_id,a.getExams()}},l=function(c){var d=$("#resultsTable2");a.dataGrid=d.DataTable({responsive:{details:{type:"column"}},columnDefs:[{className:"control",orderable:!1,targets:0}],paging:!1,destroy:!0,order:c.sortOrder,filter:!1,info:!1,sorting:[],scrollY:"200px",initComplete:function(c,d){a.loading=!1,b.loading=!1,a.$apply()},language:{lengthMenu:"Display _MENU_",emptyTable:c.noResultsTxt}})};a.cancel=function(){c.dismiss("canceled")},a.$watch("student.current_class",function(b,c){b!=c&&(a.student.class_id=a.student.current_class.class_id,a.student.class_name=a.student.current_class.class_name,a.student.class_cat_id=a.student.current_class.class_cat_id,void 0!==a.allFeeItems&&(a.feeItems=u(a.allFeeItems),a.optFeeItems=u(a.allOptFeeItems)))}),a.$watch("uploader.queue[0]",function(b,c){void 0!==b&&a.studentForm.$setDirty()}),a.$watch("student.admission_date",function(b,c){void 0!==b&&a.studentForm.$setDirty()}),a.addGuardian=function(){var b={student_id:a.student.student_id},c=e.create("addParent.html","addParentCtrl",b,{size:"md",backdrop:"static"});c.result.then(function(b){a.student.guardians.push(b)},function(){})},a.editGuardian=function(b){var c={student_id:a.student.student_id,guardian:b,action:"edit"},d=e.create("addParent.html","addParentCtrl",c,{size:"md",backdrop:"static"});d.result.then(function(b){angular.forEach(a.student.guardians,function(c,d){c.guardian_id==b.guardian_id&&(a.student.guardians[d]=b)})},function(){})},a.deleteGuardian=function(b,c){var f=e.confirm("Please Confirm","Are you sure you want to delete <b>"+b.parent_full_name+"</b> as a parent/guardian? <br><br><b><i>(THIS CAN NOT BE UNDONE)</i></b>",{size:"sm"});f.result.then(function(e){d.deleteGuardian(b.guardian_id,function(b,c,d){var e=angular.fromJson(b);"success"==e.response?a.student.guardians.splice(d.index,1):(a.error=!0,a.errMsg=e.data)},y,{index:c})})},a.sendMessage=function(a){},a.addMedicalHistory=function(){var b={student_id:a.student.student_id,medicalHistory:a.student.medical_history,action:"add"},c=e.create("addMedicalHistory.html","addMedicalHistoryCtrl",b,{size:"md",backdrop:"static"});c.result.then(function(b){angular.forEach(b,function(b,c){a.student.medical_history.push(b)})},function(){})},a.editMedical=function(b){var c={student_id:a.student.student_id,medicalCondition:b,action:"edit"},d=e.create("updateMedicalCondition.html","updateMedicalConditionCtrl",c,{size:"md",backdrop:"static"});d.result.then(function(b){angular.forEach(a.student.medical_history,function(c,d){c.medical_id==b.medical_id&&(a.student.medical_history[d]=b)})},function(){})},a.deleteMedical=function(b,c){var f=e.confirm("Please Confirm","Are you sure you want to delete <b>"+b.illness_condition+"</b> as a medical condition for this student? <br><br><b><i>(THIS CAN NOT BE UNDONE)</i></b>",{size:"sm"});f.result.then(function(e){d.deleteMedicalCondition(b.medical_id,function(b,c,d){var e=angular.fromJson(b);"success"==e.response?a.student.medical_history.splice(d.index,1):(a.error=!0,a.errMsg=e.data)},y,{index:c})})},a.$watch("student.payment_method",function(a,b){}),a.$watch("student.transport_route",function(b,c){b!=c&&angular.forEach(a.optFeeItemSelection,function(a,c){"Transport"==a.fee_item&&(a.amount=b.amount)})}),a.getFeeTabContent=function(b){a.currentFeeTab=b,"Fee Summary"==b?setTimeout(p,50):"Invoices"==b?(a.loading=!0,d.getStudentInvoices(a.student.student_id,n,y)):"Payments Received"==b&&(a.loading=!0,d.getStudentPayments(a.student.student_id,o,y))};var m=function(b,c){a.loading=!1;var d=angular.fromJson(b);"success"==d.response&&(void 0===d.nodata?(a.feeSummary=angular.copy(d.data.fee_summary),a.fees=angular.copy(d.data.fees),a.nofeeSummary=!1):(a.feeSummary=[],a.fees=[],a.nofeeSummary=!0),"Fee Summary"==a.currentFeeTab&&setTimeout(p,50))},n=function(b,c){a.loading=!1;var d=angular.fromJson(b);"success"==d.response&&(a.invoices=d.nodata?{}:angular.copy(d.data),"Invoices"==a.currentFeeTab&&setTimeout(q,10))};a.addInvoice=function(){var b=window.location.host,c=e.create("http://"+b+"/app/fees/invoiceForm.html","invoiceFormCtrl",{selectedStudent:a.student},{size:"md",
backdrop:"static"});c.result.then(function(b){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),d.getStudentBalance(a.student.student_id,m,y),d.getStudentInvoices(a.student.student_id,n,y)},function(){angular.equals(a.invoice,"")&&(a.errMsg="You did not enter an invoice!")})},a.viewInvoice=function(b){b.student_name=a.student.student_name;var c=window.location.host,f=e.create("http://"+c+"/app/fees/invoiceDetails.html","invoiceDetailsCtrl",b,{size:"md",backdrop:"static"});f.result.then(function(b){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),d.getStudentBalance(a.student.student_id,m,y),d.getStudentInvoices(a.student.student_id,n,y)},function(){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),d.getStudentBalance(a.student.student_id,m,y),d.getStudentInvoices(a.student.student_id,n,y)})};var o=function(b,c){a.loading=!1;var d=angular.fromJson(b);if("success"==d.response){var e=d.nodata?[]:angular.copy(d.data);a.payments=e.map(function(a){return a.replacement=a.replacement_payment?"Yes":"No",a.reverse=a.reversed?"Yes":"No",a}),"Payments Received"==a.currentFeeTab&&setTimeout(r,10)}},p=function(){var a={sortOrder:[5,"asc"],noResultsTxt:"This student has not been invoiced."};l(a)},q=function(){var a={sortOrder:[1,"desc"],noResultsTxt:"No invoices found."};l(a)},r=function(){var a={sortOrder:[2,"desc"],noResultsTxt:"No payments found."};l(a)};a.addPayment=function(){var b=window.location.host,c=e.create("http://"+b+"/app/fees/paymentForm.html","paymentFormCtrl",{selectedStudent:a.student},{size:"lg",backdrop:"static"});c.result.then(function(b){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),d.getStudentBalance(a.student.student_id,m,y),d.getStudentPayments(a.student.student_id,o,y)},function(){angular.equals(a.payment,"")&&(a.errMsg="You did not enter a payment!")})},a.getReceipt=function(b){var c={student:a.student,payment:b,feeItems:a.feeItems.concat(a.optFeeItems)},d=window.location.host;e.create("http://"+d+"/app/fees/receipt.html","receiptCtrl",c,{size:"md",backdrop:"static"})},a.viewPayment=function(c){c.student_id=a.student.student_id,c.student_name=a.student.student_name,b.modalLoading=!0;var f=window.location.host,g=e.create("http://"+f+"/app/fees/paymentDetails.html","paymentDetailsCtrl",c,{size:"lg",backdrop:"static"});g.result.then(function(b){void 0!==a.dataGrid&&a.dataGrid.destroy(),d.getStudentBalance(a.student.student_id,m,y),d.getStudentPayments(a.student.student_id,n,y)},function(){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),d.getStudentBalance(a.student.student_id,m,y),d.getStudentPayments(a.student.student_id,n,y)})};var s=function(a){return a.map(function(a){if(null!==a.class_cats_restriction&&"{}"!=a.class_cats_restriction){var b=a.class_cats_restriction.slice(1,-1);a.class_cats_restriction=b.split(",")}return a.amount=void 0,a.payment_method=void 0,a})},t=function(b){return b.filter(function(b){return a.student.fee_items.filter(function(a){return a.fee_item_id==b.fee_item_id&&a.active?(b.amount=a.amount,b.payment_method=a.payment_method,b.student_fee_item_id=a.student_fee_item_id,b.payment_made=a.payment_made,b):void 0})[0]})},u=function(b){var c=[];return c=a.student.new_student?b:b.filter(function(a){return a.new_student_only?void 0:a}),void 0!==a.student.current_class&&(c=c.filter(function(b){return null===b.class_cats_restriction||"{}"==b.class_cats_restriction?b:b.class_cats_restriction.indexOf(a.student.current_class.class_cat_id.toString())>-1?b:void 0})),c};a.toggleFeeItem=function(b,c){var d="optional"==c?a.optFeeItemSelection:a.feeItemSelection,e=d.indexOf(b);if(e>-1){if("optional"==c&&b.made_payment>0){var f=$dialog.confirm("Payment Made for Current Term","This student has paid for this lesson for the current term, therefore they will be removed from this optional lesson for all remaining terms. Do you wish to continue?",{size:"sm"});f.result.then(function(b){d.splice(e,1),a.studentForm.$setDirty()})}else d.splice(e,1),a.studentForm.$setDirty();"Transport"==b.fee_item&&(a.showTransport=!1)}else{var g=a.student.fee_items.filter(function(a){return a.fee_item_id==b.fee_item_id?b:void 0})[0];void 0!==g?(b.amount=g.amount,b.payment_method=g.payment_method,b.student_fee_item_id=g.student_fee_item_id,b.payment_made=g.payment_made):(b.amount=b.default_amount,b.payment_method=a.student.payment_method),d.push(b),a.studentForm.$setDirty(),"Transport"==b.fee_item&&(a.showTransport=!0)}},a.addFeeItem=function(){var a=window.location.host,b=e.create("http://"+a+"/app/fees/feeItemForm.html","feeItemFormCtrl",void 0,{size:"md",backdrop:"static"});b.result.then(function(){i()},function(){})},a.$watch("filters.class_cat_id",function(c,d){c!=d&&(a.classes=b.allClasses.filter(function(a){return a.class_cat_id==c?a:void 0}))}),a.$watch("filters.class",function(b,c){b!=c&&(a.filters.class_id=b.class_id,d.getExamTypes(b.class_cat_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data)},y))}),a.getExams=function(){a.examMarks={},a.marksNotFound=!1,void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0);var b=a.student.student_id+"/"+a.filters.class_id+"/"+a.filters.term_id;""!=a.filters.exam_type_id&&void 0!==a.filters.exam_type_id&&(b+="/"+a.filters.exam_type_id),d.getStudentExamMarks(b,v,y)};var v=function(b,c){a.loading=!1;var d=angular.fromJson(b);if("success"==d.response)if(d.nodata)a.marksNotFound=!0,a.errMsg="There are currently no exam marks entered for this search criteria.";else{a.rawExamMarks=d.data,a.examMarks={},a.examMarks.subjects=d.data.reduce(function(a,b){return-1===a.indexOf(b.subject_name)&&a.push(b.subject_name),a},[]),a.examMarks.types=[];var e="",f=[],g=0;angular.forEach(d.data,function(b,c){b.exam_type!=e&&(g>0&&(a.examMarks.types[g-1].marks=f),a.examMarks.types.push({exam_type:b.exam_type,marks:[]}),f=[],g++),f.push({mark:b.mark,grade_weight:b.grade_weight}),e=b.exam_type}),a.examMarks.types[g-1].marks=f}else a.marksNotFound=!0,a.errMsg=d.data};a.addExamMarks=function(){var b={student_id:a.student.student_id,classes:a.classes,terms:a.terms,examTypes:a.examTypes,filters:a.filters},c=e.create("addStudentExamMarks.html","addStudentExamMarksCtrl",b,{size:"md",backdrop:"static"});c.result.then(function(b){a.getExams()},function(){})},a.importExamMarks=function(){b.wipNotice()},a.exportData=function(){b.wipNotice()},a.getStudentReportCards=function(){void 0!==a.dataGrid&&(a.dataGrid.destroy(),a.dataGrid=void 0),a.reportsNotFound=!1,d.getStudentReportCards(a.student.student_id,w,y)};var w=function(b,c){a.loading=!1;var d=angular.fromJson(b);if("success"==d.response)if(d.nodata)a.reportsNotFound=!0,a.errMsg="There are currently no report cards entered for this student.";else{a.rawReportCards=d.data,a.reportCards={},a.reportCards.terms=a.rawReportCards.reduce(function(a,b){return-1===a.indexOf(b.term_name)&&a.push(b.term_name),a},[]),a.reportCards.classes=[];var e="",f="",g={},h=0;angular.forEach(a.rawReportCards,function(b,c){b.class_name!=e&&(h>0&&(a.reportCards.classes[h-1].reports=g),a.reportCards.classes.push({class_name:b.class_name,class_id:b.class_id,term_id:b.term_id,year:b.year}),g={},h++),g[b.term_name]=b.report_data,e=b.class_name,f=b.term_name}),a.reportCards.classes[h-1].reports=g}else a.reportsNotFound=!0,a.errMsg=d.data};a.addReportCard=function(){var b={student:a.student,classes:a.classes,terms:a.terms,filters:a.filters,adding:!0},c=window.location.host,d=e.create("http://"+c+"/app/exams/reportCard.html","reportCardCtrl",b,{size:"lg",backdrop:"static"});d.result.then(function(b){a.getStudentReportCards()},function(){})},a.getReportCard=function(b,c,d){var f={student:a.student,class_name:b.class_name,class_id:b.class_id,term_id:b.term_id,term_name:c,year:b.year,reportData:d,adding:!1},g=window.location.host,h=e.create("http://"+g+"/app/exams/reportCard.html","reportCardCtrl",f,{size:"lg",backdrop:"static"});h.result.then(function(b){a.getStudentReportCards()},function(){})},a.save=function(c,e){if(!c.$invalid){if("Details"==a.currentTab){void 0!==z.queue[0]&&(z.queue[0].file.name=a.student.student_id+"_"+z.queue[0].file.name,z.uploadAll());var f={student_id:a.student.student_id,user_id:b.currentUser.user_id,details:{student_category:a.student.student_category,first_name:a.student.first_name,middle_name:a.student.middle_name,last_name:a.student.last_name,gender:a.student.gender,dob:a.student.dob,nationality:a.student.nationality,current_class:a.student.class_id,update_class:h.class_id!=a.student.class_id,previous_class:h.class_id,student_image:void 0!==z.queue[0]?z.queue[0].file.name:null,active:a.student.active?"t":"f",admission_date:void 0!==a.student.admission_date.startDate?a.student.admission_date.startDate:a.student.admission_date,admission_number:a.student.admission_number,new_student:a.student.new_student?"t":"f"}}}else if("Family"==a.currentTab)var f={student_id:a.student.student_id,user_id:b.currentUser.user_id,family:{marial_status_parents:a.student.marial_status_parents,adopted:a.student.adopted?"t":"f",adopted_age:a.student.adopted_age,marital_separation_age:a.student.marital_separation_age,adoption_aware:a.student.adoption_aware?"t":"f",emergency_name:a.student.emergency_name,emergency_relationship:a.student.emergency_relationship,emergency_telephone:a.student.emergency_telephone,pick_up_drop_off_individual:a.student.pick_up_drop_off_individual}};else if("Medical History"==a.currentTab)var f={student_id:a.student.student_id,user_id:b.currentUser.user_id,medical:{has_medical_conditions:a.student.has_medical_conditions||a.student.other_medical_conditions?"t":"f",hospitalized:a.student.hospitalized?"t":"f",hospitalized_description:a.student.hospitalized?a.student.hospitalized_description:null,current_medical_treatment:a.student.current_medical_treatment?"t":"f",current_medical_treatment_description:a.student.current_medical_treatment?a.student.current_medical_treatment_description:null,other_medical_conditions:a.student.other_medical_conditions?"t":"f",other_medical_conditions_description:a.student.other_medical_conditions?a.student.other_medical_conditions_description:null}};else if("Fees"==a.currentTab)var f={student_id:a.student.student_id,user_id:b.currentUser.user_id,fees:{payment_method:a.student.payment_method,installment_option:a.student.installment_option_id,feeItems:a.feeItemSelection,optFeeItems:a.optFeeItemSelection}};d.updateStudent(f,x,y,{tab:e})}};var x=function(c,e,f){var g=angular.fromJson(c);"success"==g.response?(void 0!==z.queue[0]&&(a.student.student_image=z.queue[0].file.name),h=angular.copy(a.student),a.studentForm.$setPristine(),void 0!==f.tab&&j(f.tab),"Fees"==a.currentTab&&d.getStudentBalance(a.student.student_id,m,y),b.$emit("studentAdded",{msg:"Student was updated.",clear:!0})):(a.error=!0,a.errMsg=g.data)},y=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data},z=a.uploader=new f({url:"upload.php",formData:[{dir:"students"}]})}]).controller("addParentCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.guardian=e.guardian||{},a.edit="edit"==e.action;var f=b.currentUser.settings["Guardian Relationships"];a.relationships=f.split(",");var g=b.currentUser.settings["Marital Statuses"];a.maritalStatuses=g.split(",");var h=b.currentUser.settings.Titles;a.titles=h.split(","),a.cancel=function(){c.dismiss("Canceled")},a.save=function(c){if(!c.$invalid)if(a.edit)a.update();else{var f={student_id:e.student_id,guardian:a.guardian,user_id:b.currentUser.user_id};d.postGuardian(f,i,j)}},a.update=function(){var c={guardian:a.guardian,user_id:b.currentUser.user_id};d.updateGuardian(c,i,j)};var i=function(b,d){var e=angular.fromJson(b);"success"==e.response?(a.guardian.guardian_id=e.data,a.guardian.parent_full_name=a.guardian.first_name+" "+a.guardian.middle_name+" "+a.guardian.last_name,c.close(a.guardian)):(a.error=!0,a.errMsg=e.data)},j=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]).run(["$templateCache",function(a){a.put("addParent.html",'<form name="parentForm" class="form-horizontal modalForm" novalidate role="form" ng-submit="save(parentForm)"><div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Add Parent/Guardian</h4></div><div class="modal-body cleafix"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- last name --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.last_name.$dirty ) && parentForm.last_name.$invalid && parentForm.last_name.$error.required }"><label for="last_name" class="col-sm-3 control-label">Last Name</label><div class="col-sm-9"><input type="text" name="last_name" ng-model="guardian.last_name" class="form-control" required /><p ng-show="(parentForm.$submitted || parentForm.last_name.$dirty ) && parentForm.last_name.$invalid && parentForm.last_name.$error.required" class="help-block"><i class="fa fa-exclamation-triangle"></i> Last Name is required.</p></div></div><!-- first name --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.first_name.$dirty ) && parentForm.first_name.$invalid && parentForm.first_name.$error.required }"><label for="first_name" class="col-sm-3 control-label">First Name</label><div class="col-sm-9"><input type="text" name="first_name" ng-model="guardian.first_name" class="form-control" required /><p ng-show="(parentForm.$submitted || parentForm.first_name.$dirty ) && parentForm.first_name.$invalid && parentForm.first_name.$error.required" class="help-block"><i class="fa fa-exclamation-triangle"></i> First Name is required.</p></div>	</div><!-- middle name --><div class="form-group"><label for="middle_name" class="col-sm-3 control-label">Middle Name</label><div class="col-sm-9"><input type="text" name="middle_name" ng-model="guardian.middle_name" class="form-control" />	</div>	</div><!-- name title --><div class="form-group" ><label for="title" class="col-sm-3 control-label">Title</label><div class="col-sm-9"><select name="title" ng-model="guardian.title" class="form-control"><option value="{{title}}" ng-repeat="title in titles">{{title}}</option></select></div>	</div>	<!-- id number --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.id_number.$dirty ) && parentForm.id_number.$invalid && parentForm.id_number.$error.required }"><label for="id_number" class="col-sm-3 control-label">ID Number</label><div class="col-sm-9"><input type="text" name="id_number" ng-model="guardian.id_number" class="form-control" required numeric-only />	<p ng-show="(parentForm.$submitted || parentForm.id_number.$dirty ) && parentForm.id_number.$invalid && parentForm.id_number.$error.required" class="help-block"><i class="fa fa-exclamation-triangle"></i> ID Number is required.</p></div></div><!-- address --><div class="form-group"><label for="address" class="col-sm-3 control-label">Address</label><div class="col-sm-9"><input type="text" name="address" ng-model="guardian.address" class="form-control"  >	</div></div><!-- phone number --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.telephone.$dirty ) && parentForm.telephone.$invalid && parentForm.telephone.$error.required }"><label for="telephone" class="col-sm-3 control-label">Telephone</label><div class="col-sm-9"><input type="text" name="telephone" ng-model="guardian.telephone" class="form-control" required numeric-only />	<p ng-show="(parentForm.$submitted || parentForm.telephone.$dirty ) && parentForm.telephone.$invalid && parentForm.telephone.$error.required" class="help-block"><i class="fa fa-exclamation-triangle"></i> Telephone number is required.</p></div>	</div><!-- email --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.email.$dirty ) && parentForm.email.$invalid && parentForm.email.$error.required }"><label for="email" class="col-sm-3 control-label">Email</label><div class="col-sm-9"><input type="email" name="email" ng-model="guardian.email" class="form-control" required />	<p ng-show="(parentForm.$submitted || parentForm.email.$dirty ) && parentForm.email.$invalid && parentForm.email.$error.required" class="help-block"><i class="fa fa-exclamation-triangle"></i> Email is required.</p><p ng-show="(parentForm.$submitted || parentForm.email.$dirty ) && parentForm.email.$invalid && parentForm.email.$error.email" class="help-block"><i class="fa fa-exclamation-triangle"></i> Invalid email</p></div>	</div><!-- occupation --><div class="form-group">	<label for="occupation" class="col-sm-3 control-label">Occupation</label><div class="col-sm-9"><input type="text" name="occupation" ng-model="guardian.occupation" class="form-control"  >	</div>	</div><!-- employer --><div class="form-group">	<label for="employer" class="col-sm-3 control-label">Employer</label><div class="col-sm-9"><input type="text" name="employer" ng-model="guardian.employer" class="form-control"  >	</div>	</div><!-- employer address --><div class="form-group">	<label for="employer_address" class="col-sm-3 control-label">Employer Address</label><div class="col-sm-9"><input type="text" name="employer_address" ng-model="guardian.employer_address" class="form-control"  >	</div>	</div><!-- phone number --><div class="form-group">	<label for="work_phone" class="col-sm-3 control-label">Work Phone</label><div class="col-sm-9"><input type="text" name="work_phone" ng-model="guardian.work_phone" class="form-control" numeric-only />	</div>	</div><!-- work_email --><div class="form-group" ng-class="{ \'has-error\' : (parentForm.$submitted || parentForm.work_email.$dirty ) && parentForm.work_email.$invalid && (parentForm.work_email.$error.required || parentForm.work_email.$error.email) }"><label for="work_email" class="col-sm-3 control-label">Work Email</label><div class="col-sm-9"><input type="email" name="work_email" ng-model="guardian.work_email" class="form-control"  >	<p ng-show="(parentForm.$submitted || parentForm.work_email.$dirty ) && parentForm.work_email.$invalid && parentForm.work_email.$error.email" class="help-block"><i class="fa fa-exclamation-triangle"></i> Invalid email</p></div>	</div><!-- relationship --><div class="form-group">		<label for="relationship" class="col-sm-3 control-label">Relationship</label><div class="col-sm-9"><select name="relationship" ng-model="guardian.relationship" class="form-control"><option value="">--select relationship--</option><option value="{{item}}" ng-repeat="item in relationships">{{item}}</option></select></div>	</div><!-- marital status --><div class="form-group">		<label for="marital_status" class="col-sm-3 control-label">Marital Status</label><div class="col-sm-9"><select name="marital_status" ng-model="guardian.marital_status" class="form-control"><option value="">--select one--</option><option value="{{item}}" ng-repeat="item in maritalStatuses">{{item}}</option></select></div>	</div></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button ng-show="!edit" type="submit" class="btn btn-primary">Save</button><button ng-show="edit" type="submit" class="btn btn-primary">Update</button></div></form>')}]).controller("addMedicalHistoryCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.fullMedicalHistory=e.medicalHistory||{};var f=b.currentUser.settings["Medical Conditions"];f=f.split(",");var g=a.fullMedicalHistory.reduce(function(a,b){return a.push(b.illness_condition),a},[]);a.medicalConditions=f.reduce(function(a,b){return-1===g.indexOf(b)&&a.push({illness_condition:b,age:"",comments:""}),a},[]),a.cancel=function(){c.dismiss("Canceled")},a.save=function(){var c={student_id:e.student_id,medicalConditions:a.conditionSelection,user_id:b.currentUser.user_id};d.postMedicalConditions(c,h,i)};var h=function(b,d){var e=angular.fromJson(b);"success"==e.response?(angular.forEach(e.data,function(b,c){a.conditionSelection[c].medical_id=b.medical_id,a.conditionSelection[c].date_medical_added=b.date_medical_added}),c.close(a.conditionSelection)):(a.error=!0,a.errMsg=e.data)},i=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()},a.conditionSelection=[],a.toggleMedicalCondition=function(b){var c=a.conditionSelection.indexOf(b);c>-1?a.conditionSelection.splice(c,1):a.conditionSelection.push(b)}}]).run(["$templateCache",function(a){a.put("addMedicalHistory.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Add Medical History</h4></div><div class="modal-body cleafix"><ng-form name="cargoDialog" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><table class="display dataTable"><thead><tr><th>Illness/Condition</th><th>Age</th><th>Explain</th></tr></thead><tbody><tr ng-class-odd="\'odd\'" ng-class-even="\'even\'" ng-repeat="item in medicalConditions track by $index"><td width="150"><label class="checkbox-inline"><input type="checkbox" name="conditions[]" value="{{item.illness_condition}}" ng-checked="conditionSelection.indexOf(item) > -1" ng-click="toggleMedicalCondition(item)" > {{item.illness_condition}}</label></td><td width="80"><input type="text" class="form-control" name="medical_condition_age[]" ng-model="item.age" ></td><td><input type="text" class="form-control" name="medical_condition_comments[]" ng-model="item.comments" ></td></tr></tbody></table></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button ng-show="!edit" type="button" class="btn btn-primary" ng-click="save()">Save</button></div>')}]).controller("updateMedicalConditionCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.medicalCondition=e.medicalCondition||{},a.cancel=function(){c.dismiss("Canceled")},a.save=function(){var c={student_id:e.student_id,medicalCondition:a.medicalCondition,user_id:b.currentUser.user_id};d.updateMedicalConditions(c,f,g)};var f=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(a.medicalCondition):(a.error=!0,a.errMsg=e.data)},g=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()}}]).run(["$templateCache",function(a){a.put("updateMedicalCondition.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Update Medical Condition : {{medicalCondition.illness_condition}}</h4></div><div class="modal-body cleafix"><ng-form name="cargoDialog" class="form-horizontal modalForm" novalidate role="form"><div class="row"><div class="col-sm-12"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><!-- Age --><div class="form-group"><div class="col-sm-12"><label for="age">Age</label></div><div class="col-sm-3"><input type="text" name="age" ng-model="medicalCondition.age" class="form-control"  ></div></div><!-- Explain --><div class="form-group"><div class="col-sm-12"><label for="comments">Explain</label></div><div class="col-sm-12"><textarea name="comments" rows="5" ng-model="medicalCondition.comments" class="form-control"></textarea></div></div></div></div></ng-form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button ng-show="!edit" type="button" class="btn btn-primary" ng-click="save()">Save</button></div>')}]).controller("addStudentExamMarksCtrl",["$scope","$rootScope","$uibModalInstance","apiService","data",function(a,b,c,d,e){a.student_id=e.student_id,a.filters=e.filters,a.classes=e.classes,a.terms=e.terms,a.examTypes=e.examTypes,a.cancel=function(){c.dismiss("Canceled")},a.$watch("filters.class",function(b,c){b!=c&&(a.filters.class_id=b.class_id,d.getExamTypes(b.class_cat_id,function(b){var c=angular.fromJson(b);"success"==c.response&&(a.examTypes=c.data)},g))}),a.getStudentExams=function(b){if(!b.$invalid){a.examMarks={},a.marksNotFound=!1,a.currentFilters=angular.copy(a.filters);var c=a.filters.class_id+"/"+a.filters.exam_type_id;d.getClassExams(c,function(b){a.loading=!1;var c=angular.fromJson(b);if("success"==c.response)if(void 0!==c.nodata)a.examNotFound=!0;else{var e=c.data,f=a.student_id+"/"+a.filters.class_id+"/"+a.filters.term_id+"/"+a.filters.exam_type_id;d.getStudentExamMarks(f,function(b){a.loading=!1;var c=angular.fromJson(b);"success"==c.response&&(a.marks=c.nodata?[]:c.data,a.marks.length>0?a.subjects=e.map(function(b){var c=a.marks.filter(function(a){return a.subject_name==b.subject_name?a:void 0})[0];return b.mark=void 0!==c?c.mark:void 0,b}):a.subjects=e)},g)}},g)}},a.save=function(){var c=[];angular.forEach(a.subjects,function(b,d){c.push({student_id:a.student_id,class_sub_exam_id:b.class_sub_exam_id,term_id:a.currentFilters.term_id,mark:b.mark})});var e={user_id:b.currentUser.user_id,exam_marks:c};d.addExamMarks(e,f,g)};var f=function(b,d){var e=angular.fromJson(b);"success"==e.response?c.close(a.subjects):(a.error=!0,a.errMsg=e.data)},g=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data};a.hitEnter=function(b){angular.equals(b.keyCode,13)&&a.save()};var g=function(b,c){var d=angular.fromJson(b);a.error=!0,a.errMsg=d.data}}]).run(["$templateCache",function(a){a.put("addStudentExamMarks.html",'<div class="modal-header dialog-header-form"><h4 class="modal-title"><span class="glyphicon glyphicon-plus"></span> Add Exam Marks</h4></div><div class="modal-body cleafix"><form name="examForm" class="form-horizontal modalForm" novalidate role="form"><div ng-show="error" class="alert alert-danger">{{errMsg}}</div><div class="row header"><div class="modalDataFilter col-sm-12 clearfix">	<!-- Class --><div class="form-group"><label for="class">Class</label><select name="class_id" class="form-control" ng-options="class.class_name for class in classes track by class.class_id" ng-model="filters.class" required><option value="">--select class--</option></select><p ng-show="examForm.class_id.$invalid && (examForm.class_id.$touched || examForm.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Class is required.</p></div>	<!-- Term --><div class="form-group"><label for="term">Term</label>	<select name="term_id" class="form-control" ng-options="item.term_id as item.term_year_name for item in terms" ng-model="filters.term_id" required><option value="">--select term--</option></select><p ng-show="examForm.term_id.$invalid && (examForm.term_id.$touched || examForm.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Term is required.</p></div><!-- Exam --><div class="form-group"><label for="exam_type">Exam</label><select name="exam_type" class="form-control" ng-options="exam.exam_type_id as exam.exam_type for exam in examTypes" ng-model="filters.exam_type_id" required><option value="">-- select exam --</option></select><p ng-show="examForm.exam_type.$invalid && (examForm.exam_type.$touched || examForm.$submitted)" class="help-block"><i class="fa fa-exclamation-triangle"></i> Exam Type is required.</p></div><!-- search btn --><div class="form-group submit-btn"><input type="submit" class="btn btn-sm btn-info" ng-click="getStudentExams(examForm)" value="Load" /><span ng-show="loading" class="fa fa-spinner fa-pulse"></span></div>	<hr></div></div><p ng-show="examNotFound" class="error alert alert-danger">The selected exam has not been set up for this class.</p><div class="row"><div class="col-sm-6" ng-repeat="item in subjects track by $index"><label class="col-sm-6">{{item.subject_name}}</label><div class="input-group col-sm-6"><input type="text" class="form-control" ng-model="item.mark" numeric-only /><div class="input-group-addon"> / {{item.grade_weight}}</div></div></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-link" ng-click="cancel()">Cancel</button><button type="button" class="btn btn-primary" ng-click="save()">Save</button></div>')}]),angular.module("eduwebApp").factory("Auth",["$http","$rootScope","$window","Session","AUTH_EVENTS","ajaxService",function(a,b,c,d,e,f){var g={};return g.login=function(a,g,h){var i=window.location.host,j=i.indexOf("eduweb.co.ke")>-1?"http://api.eduweb.co.ke":"http://api.eduweb.localhost";f.AjaxPost(a,j+"/login",function(a){"success"==a.response?(a.data.settings=a.data.settings.reduce(function(a,b){return a[b.name]=b.value,a},{}),c.sessionStorage.userInfo=JSON.stringify(a.data),d.create(a.data),b.currentUser=a.data,b.$broadcast(e.loginSuccess),g(a.data)):b.$broadcast(e.loginFailed,{errorMsg:a.data})},function(a){b.$broadcast(e.loginFailed,{errorMsg:a.data}),h()})},g.isAuthenticated=function(){return!!d.user},g.isAuthorized=function(a){return angular.isArray(a)||(a=[a]),g.isAuthenticated()&&-1!==a.indexOf(d.userRole)},g.logout=function(){d.destroy(),c.sessionStorage.removeItem("userInfo"),b.$broadcast(e.logoutSuccess)},g}]),angular.module("eduwebApp").service("Session",["$rootScope","USER_ROLES",function(a,b){return this.create=function(a){this.user=a,this.userRole=a.user_type},this.destroy=function(){this.user=null,this.userRole=null},this}]),angular.module("eduwebApp").service("ajaxService",["$http","$rootScope",function(a,b){var c=0;return this.AjaxPost=function(b,c,d,e,f){a({method:"POST",url:c,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:b}).success(function(a,b,c,e){d(a,b,f)}).error(function(a){e(a)})},this.AjaxPost2=function(b,c,d,e,f){a({method:"POST",url:c,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:b}).success(function(a,b,c,e){d(a,b,f)}).error(function(a){e(a)})},this.AjaxPut=function(b,c,d,e,f){a({method:"PUT",url:c,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:b}).success(function(a,b,c,e){d(a,b,f)}).error(function(a){e(a)})},this.AjaxDelete=function(b,c,d,e){a({method:"DELETE",url:b}).success(function(a,b,d,f){c(a,b,e)}).error(function(a){d(a)})},this.AjaxGet=function(b,c,d,e){a({method:"GET",url:b}).success(function(a,b,d,f){c(a,b,e)}).error(function(a){d(a)})},this.AjaxGetWithData=function(b,c,d,e,f){a({method:"GET",url:c,params:b}).success(function(a,b,c,e){d(a,b,f)}).error(function(a){e(a)})},this.JSONPGet=function(d,e,f,g,h){1===++c&&b.$broadcast("loading:progress"),a.jsonp(e).success(function(a,d,e,g){0===--c&&b.$broadcast("loading:finish"),f(a,d,h)}).error(function(a){0===--c&&b.$broadcast("loading:finish"),g(a)})},this}]),angular.module("eduwebApp").service("apiService",["$rootScope","ajaxService",function(a,b){var c=window.location.host,d=c.indexOf("eduweb.co.ke")>-1?"http://api.eduweb.co.ke":"http://api.eduweb.localhost";return this.getClassCats=function(a,c,e,f){void 0===a?b.AjaxGet(d+"/getClassCats",c,e,f):b.AjaxGet(d+"/getClassCats/"+a,c,e,f)},this.getClassCatsSummary=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getClassCatsSummary",c,e,f)},this.addClassCat=function(a,c,e,f){b.AjaxPost2(a,d+"/addClassCat/",c,e,f)},this.updateClassCat=function(a,c,e,f){b.AjaxPut(a,d+"/updateClassCat/",c,e,f)},this.setClassCatStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setClassCatStatus/",c,e,f)},this.getEmpCats=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getEmployeeCats",c,e,f)},this.addEmployeeCat=function(a,c,e,f){b.AjaxPost2(a,d+"/addEmployeeCat/",c,e,f)},this.updateEmployeeCat=function(a,c,e,f){b.AjaxPut(a,d+"/updateEmployeeCat/",c,e,f)},this.setEmployeeCatStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setEmployeeCatStatus/",c,e,f)},this.getDepts=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getDepartments",c,e,f)},this.getDeptSummary=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getDeptSummary",c,e,f)},this.setDeptStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setDeptStatus/",c,e,f)},this.addDept=function(a,c,e,f){b.AjaxPost2(a,d+"/addDepartment/",c,e,f);
},this.updateDept=function(a,c,e,f){b.AjaxPut(a,d+"/updateDepartment/",c,e,f)},this.updateSetting=function(a,c,e,f){b.AjaxPut(a,d+"/updateSetting/",c,e,f)},this.updateSettings=function(a,c,e,f){b.AjaxPut(a,d+"/updateSettings/",c,e,f)},this.getSettings=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getSettings",c,e,f)},this.getGrading=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getGrading",c,e,f)},this.addGrading=function(a,c,e,f){b.AjaxPost2(a,d+"/addGrading/",c,e,f)},this.updateGrading=function(a,c,e,f){b.AjaxPut(a,d+"/updateGrading/",c,e,f)},this.getCountries=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getCountries",c,e,f)},this.getInstallmentOptions=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getInstallmentOptions",c,e,f)},this.getAllClasses=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getAllClasses",c,e,f)},this.getTeacherClasses=function(a,c,e,f){b.AjaxGet(d+"/getTeacherClasses/"+a,c,e,f)},this.getClasses=function(a,c,e,f){b.AjaxGet(d+"/getClasses/"+a,c,e,f)},this.addClass=function(a,c,e,f){b.AjaxPost2(a,d+"/addClass/",c,e,f)},this.updateClass=function(a,c,e,f){b.AjaxPut(a,d+"/updateClass/",c,e,f)},this.setClassStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setClassStatus/",c,e,f)},this.getFeeItems=function(a,c,e){b.AjaxGetWithData(a,d+"/getFeeItems",c,e)},this.getTansportRoutes=function(a,c,e){b.AjaxGetWithData(a,d+"/getTansportRoutes",c,e)},this.getReplaceableFeeItems=function(a,c,e,f){b.AjaxGet(d+"/getReplaceableFeeItems/"+a,c,e,f)},this.getStudentFeeItems=function(a,c,e,f){b.AjaxGet(d+"/getStudentFeeItems/"+a,c,e,f)},this.addFeeItem=function(a,c,e,f){b.AjaxPost2(a,d+"/addFeeItem/",c,e,f)},this.updateFeeItem=function(a,c,e,f){b.AjaxPut(a,d+"/updateFeeItem/",c,e,f)},this.setFeeItemStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setFeeItemStatus/",c,e,f)},this.updateRoutes=function(a,c,e,f){b.AjaxPut(a,d+"/updateRoutes/",c,e,f)},this.getTerms=function(a,c,e,f){void 0===a?b.AjaxGet(d+"/getTerms",c,e,f):b.AjaxGet(d+"/getTerms/"+a,c,e,f)},this.addTerm=function(a,c,e,f){b.AjaxPost2(a,d+"/addTerm/",c,e,f)},this.updateTerm=function(a,c,e,f){b.AjaxPut(a,d+"/updateTerm/",c,e,f)},this.getCurrentTerm=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getCurrentTerm",c,e,f)},this.getNextTerm=function(a,c,e,f){b.AjaxGetWithData(a,d+"/getNextTerm",c,e,f)},this.getSubjects=function(a,c,e,f){b.AjaxGet(d+"/getSubjects/"+a,c,e,f)},this.addSubject=function(a,c,e,f){b.AjaxPost2(a,d+"/addSubject/",c,e,f)},this.updateSubject=function(a,c,e,f){b.AjaxPut(a,d+"/updateSubject/",c,e,f)},this.setSubjectStatus=function(a,c,e,f){b.AjaxPut(a,d+"/setSubjectStatus/",c,e,f)},this.getAllTeachers=function(a,c,e){b.AjaxGet(d+"/getAllTeachers/"+a,c,e)},this.getAllEmployees=function(a,c,e){b.AjaxGet(d+"/getAllEmployees/"+a,c,e)},this.addEmployee=function(a,c,e,f){b.AjaxPost2(a,d+"/addEmployee/",c,e,f)},this.getEmployeeDetails=function(a,c,e,f){b.AjaxGet(d+"/getEmployeeDetails/"+a,c,e,f)},this.updateEmployee=function(a,c,e,f){b.AjaxPut(a,d+"/updateEmployee/",c,e,f)},this.getExamTypes=function(a,c,e,f){void 0===a?b.AjaxGet(d+"/getExamTypes",c,e,f):b.AjaxGet(d+"/getExamTypes/"+a,c,e,f)},this.deleteExamType=function(a,c,e,f){b.AjaxDelete(d+"/deleteExamType/"+a,c,e,f)},this.addExamMarks=function(a,c,e,f){b.AjaxPost2(a,d+"/addExamMarks/",c,e,f)},this.getClassExams=function(a,c,e,f){b.AjaxGet(d+"/getClassExams/"+a,c,e,f)},this.addExamType=function(a,c,e,f){b.AjaxPost2(a,d+"/addExamType/",c,e,f)},this.getClassExamMarks=function(a,c,e,f){b.AjaxGet(d+"/getClassExamMarks/"+a,c,e,f)},this.getTopStudents=function(a,c,e,f){void 0===a?b.AjaxGet(d+"/getTopStudents",c,e,f):b.AjaxGet(d+"/getTopStudents/"+a,c,e,f)},this.getAllStudentReportCards=function(a,c,e,f){b.AjaxGet(d+"/getAllStudentReportCards/"+a,c,e,f)},this.getStudentReportCards=function(a,c,e,f){b.AjaxGet(d+"/getStudentReportCards/"+a,c,e,f)},this.getStudentReportCard=function(a,c,e,f){b.AjaxGet(d+"/getStudentReportCard/"+a,c,e,f)},this.getExamMarksforReportCard=function(a,c,e,f){b.AjaxGet(d+"/getExamMarksforReportCard/"+a,c,e,f)},this.addReportCard=function(a,c,e,f){b.AjaxPost2(a,d+"/addReportCard/",c,e,f)},this.getAllStudents=function(a,c,e,f){b.AjaxGet(d+"/getAllStudents/"+a,c,e,f)},this.getTeacherStudents=function(a,c,e,f){b.AjaxGet(d+"/getTeacherStudents/"+a,c,e,f)},this.getStudentDetails=function(a,c,e,f){b.AjaxGet(d+"/getStudentDetails/"+a,c,e,f)},this.getStudentBalance=function(a,c,e,f){b.AjaxGet(d+"/getStudentBalance/"+a,c,e,f)},this.getStudentInvoices=function(a,c,e,f){b.AjaxGet(d+"/getStudentInvoices/"+a,c,e,f)},this.getStudentPayments=function(a,c,e,f){b.AjaxGet(d+"/getStudentPayments/"+a,c,e,f)},this.getStudentExamMarks=function(a,c,e,f){b.AjaxGet(d+"/getStudentExamMarks/"+a,c,e,f)},this.getAllStudentExamMarks=function(a,c,e,f){b.AjaxGet(d+"/getAllStudentExamMarks/"+a,c,e,f)},this.postStudent=function(a,c,e,f){b.AjaxPost2(a,d+"/addStudent/",c,e,f)},this.updateStudent=function(a,c,e,f){b.AjaxPut(a,d+"/updateStudent/",c,e,f)},this.postGuardian=function(a,c,e,f){b.AjaxPost2(a,d+"/addGuardian/",c,e,f)},this.updateGuardian=function(a,c,e,f){b.AjaxPut(a,d+"/updateGuardian/",c,e,f)},this.deleteGuardian=function(a,c,e,f){b.AjaxDelete(d+"/deleteGuardian/"+a,c,e,f)},this.postMedicalConditions=function(a,c,e,f){b.AjaxPost2(a,d+"/addMedicalConditions/",c,e,f)},this.updateMedicalConditions=function(a,c,e,f){b.AjaxPut(a,d+"/updateMedicalConditions/",c,e,f)},this.deleteMedicalCondition=function(a,c,e,f){b.AjaxDelete(d+"/deleteMedicalCondition/"+a,c,e,f)},this.getStudentClassess=function(a,c,e,f){b.AjaxGet(d+"/getStudentClassess/"+a,c,e,f)},this.getPaymentsReceived=function(a,c,e,f){b.AjaxGet(d+"/getPaymentsReceived/"+a,c,e,f)},this.getPaymentsDue=function(a,c,e,f){b.AjaxGet(d+"/getPaymentsDue/"+a,c,e,f)},this.getPaymentsPastDue=function(a,c,e,f){b.AjaxGet(d+"/getPaymentsPastDue",c,e,f)},this.getTotalsForTerm=function(a,c,e,f){b.AjaxGet(d+"/getTotalsForTerm",c,e,f)},this.getStudentBalances=function(a,c,e,f){b.AjaxGet(d+"/getStudentBalances/"+a,c,e,f)},this.addPayment=function(a,c,e,f){b.AjaxPost2(a,d+"/addPayment/",c,e,f)},this.getPaymentDetails=function(a,c,e,f){b.AjaxGet(d+"/getPaymentDetails/"+a,c,e,f)},this.updatePayment=function(a,c,e,f){b.AjaxPut(a,d+"/updatePayment/",c,e,f)},this.reversePayment=function(a,c,e,f){b.AjaxPut(a,d+"/reversePayment/",c,e,f)},this.reactivatePayment=function(a,c,e,f){b.AjaxPut(a,d+"/reactivatePayment/",c,e,f)},this.getInvoices=function(a,c,e,f){b.AjaxGet(d+"/getInvoices/"+a,c,e,f)},this.getOpenInvoices=function(a,c,e,f){b.AjaxGet(d+"/getOpenInvoices/"+a,c,e,f)},this.getInvoiceDetails=function(a,c,e,f){b.AjaxGet(d+"/getInvoiceDetails/"+a,c,e,f)},this.generateInvoices=function(a,c,e,f){b.AjaxGet(d+"/generateInvoices/"+a,c,e,f)},this.createInvoice=function(a,c,e,f){b.AjaxPost2(a,d+"/createInvoice/",c,e,f)},this.updateInvoice=function(a,c,e,f){b.AjaxPut(a,d+"/updateInvoice/",c,e,f)},this.cancelInvoice=function(a,c,e,f){b.AjaxPut(a,d+"/cancelInvoice/",c,e,f)},this.reactivateInvoice=function(a,c,e,f){b.AjaxPut(a,d+"/reactivateInvoice/",c,e,f)},this}]);